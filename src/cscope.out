cscope 15 /home/hanyang/jjo/cache_code/extremestorage/src               0000098731
	@dm-writeboost-daemon.c

20 
	~"dm-wr™eboo¡.h
"

21 
	~"dm-wr™eboo¡-m‘ad©a.h
"

22 
	~"dm-wr™eboo¡-d«mÚ.h
"

24 
	~<lšux/rbŒ“.h
>

26 
	#ACACHE


	)

28 #ifdeà
ACACHE


36 
	$check_io_·‰”n
(
wb_deviû
 *
wb
, 
£gm’t_h—d”
 *
£g
)

38 
u8
 
i
 = 0;

39 
u64
 
´ev_£ùÜ
 = 0;

40 
£qu’tŸl_couÁ
 = 0;

41 
m‘ablock
 *
mb
 = 
£g
->
mb_¬¿y
;

42 
´ev_£ùÜ
 = 
mb
->
£ùÜ
;

43 
	`´štk
("check_io_·‰”n(èËngth: %Îu\n",
£g
->
Ëngth
);

44 
i
 = 1; i < 
£g
->
Ëngth
; i++) {

45 
mb
 = 
£g
->
mb_¬¿y
 + 
i
;

46 ià(
´ev_£ùÜ
 =ğ
mb
->
£ùÜ
 - 8)

47 
£qu’tŸl_couÁ
++;

49 
£qu’tŸl_couÁ
--;

51 
´ev_£ùÜ
 = 
mb
->
£ùÜ
;

54 
	`´štk
("check_io_·‰”n(): seq_couÁ: %u\n",
£qu’tŸl_couÁ
);

56 ià(
wb
->
£qu’tŸl_th»shŞd
 > 
£qu’tŸl_couÁ
)

58  
£qu’tŸl_couÁ
;

59 
	}
}

68 
	$£qu’tŸl_wr™e
(
wb_deviû
 *
wb
, 
¿mbufãr
 *
¿mbuf
, 
£gm’t_h—d”
 *
£g
)

70 
u8
 
i
, 
j
;

71 
m‘ablock
 *
mb
;

72 
	`´štk
("segment_write\n");

74 
i
 = 0; i < 
£g
->
Ëngth
 ; i++) {

75 
mb
 = 
£g
->
mb_¬¿y
 + 
i
;

77 ià(
mb
->
dœtšess
.
is_dœty
)

78 
mb
->
dœtšess
.
is_dœty
 = 
çl£
;

81 ià(255 =ğ
mb
->
dœtšess
.
d©a_b™s
) {

82 
dm_io_»que¡
 
io_»q
 = {

83 
WB_IO_WRITE
,

84 .
ş›Á
 = 
wb
->
io_ş›Á
,

85 .
nÙify
.
â
 = 
NULL
,

86 .
mem
.
ty³
 = 
DM_IO_VMA
,

87 .
mem
.
±r
.
addr
 = 
¿mbuf
->
d©a
 + (
i
 << 12),

89 
dm_io_»giÚ
 
»giÚ
 = {

90 .
bdev
 = 
wb
->
backšg_dev
->bdev,

91 .
£ùÜ
 = 
mb
->sector,

92 .
couÁ
 = 1 << 3,

94 ià(
	`wb_io
(&
io_»q
, 1, &
»giÚ
, 
NULL
, 
çl£
)) {

95 
	`´štk
("segment_write_throgh 4KB writeƒrror..\n");

99 
	`´štk
("b™ wr™IO debug: d©a:%Îu, seùÜ: %Îu, _b™s: %u\n",
¿mbuf
->
d©a
+(
i
<<12),
mb
->
£ùÜ
,mb->
dœtšess
.
d©a_b™s
);

100 
j
 = 0; j < 8; j++) {

101 
dm_io_»que¡
 
io_»q
;

102 
dm_io_»giÚ
 
»giÚ
;

104 
boŞ
 
b™_Ú
 = 
mb
->
dœtšess
.
d©a_b™s
 & (1 << 
j
);

105 ià(!
b™_Ú
)

108 
io_»q
 = (
dm_io_»que¡
) {

109 
WB_IO_WRITE
,

110 .
ş›Á
 = 
wb
->
io_ş›Á
,

111 .
nÙify
.
â
 = 
NULL
,

112 .
mem
.
ty³
 = 
DM_IO_VMA
,

113 .
mem
.
±r
.
addr
 = 
¿mbuf
->
d©a
 + ((
i
 << 12è+ (
j
 << 9)),

115 
»giÚ
 = (
dm_io_»giÚ
) {

116 .
bdev
 = 
wb
->
backšg_dev
->bdev,

117 .
£ùÜ
 = 
mb
->£ùÜ + 
j
,

118 .
couÁ
 = 1,

120 ià(
	`wb_io
(&
io_»q
, 1, &
»giÚ
, 
NULL
, 
çl£
)) {

121 
	`´štk
("segment_write_throgh 512KB writeƒrror..\n");

128 
	}
}

134 
	$queue_b¬r›r_io
(
wb_deviû
 *
wb
, 
bio
 *bio)

136 
	`mu‹x_lock
(&
wb
->
io_lock
);

137 
	`bio_li¡_add
(&
wb
->
b¬r›r_ios
, 
bio
);

138 
	`mu‹x_uÆock
(&
wb
->
io_lock
);

144 
	`queue_wÜk
(
wb
->
b¬r›r_wq
, &wb->
æush_b¬r›r_wÜk
);

145 
	}
}

147 
	$æush_b¬r›r_ios
(
wÜk_¡ruù
 *
wÜk
)

149 
wb_deviû
 *
wb
 = 
	`cÚš”_of
(

150 
wÜk
, 
wb_deviû
, 
æush_b¬r›r_wÜk
);

152 ià(
	`bio_li¡_em±y
(&
wb
->
b¬r›r_ios
))

155 
	`©omic64_šc
(&
wb
->
couÁ_nÚ_fuÎ_æushed
);

156 
	`æush_cu¼’t_bufãr
(
wb
);

157 
	}
}

161 
	$´oûss_deã¼ed_b¬r›rs
(
wb_deviû
 *
wb
, 
¿mbufãr
 *
¿mbuf
)

163 
boŞ
 
has_b¬r›r
 = !
	`bio_li¡_em±y
(&
¿mbuf
->
b¬r›r_ios
);

164 ià(
has_b¬r›r
) {

165 
bio
 *bio;

168 
”r
 = 
	`blkdev_issue_æush
(
wb
->
ÿche_dev
->
bdev
, 
GFP_NOIO
, 
NULL
);

171 (
bio
 = 
	`bio_li¡_pİ
(&
¿mbuf
->
b¬r›r_ios
)))

179 ià(
	`uÆik–y
(
”r
))

180 
	`bio_io_”rÜ
(
bio
);

182 
	`bio_io_sucûss_com·t
(
bio
);

184 
	}
}

186 
boŞ
 
	$should_æush
(
wb_deviû
 *
wb
)

188  
	`©omic64_»ad
(&
wb
->
Ï¡_queued_£gm’t_id
) >

189 
	`©omic64_»ad
(&
wb
->
Ï¡_æushed_£gm’t_id
);

190 
	}
}

192 
	$do_æush_´oc
(
wb_deviû
 *
wb
)

194 
£gm’t_h—d”
 *
£g
;

195 
¿mbufãr
 *
¿mbuf
;

196 
u64
 
id
;

197 
dm_io_»que¡
 
io_»q
;

198 
dm_io_»giÚ
 
»giÚ
;

200 ià(!
	`should_æush
(
wb
)) {

201 
	`scheduË_timeout_š‹¼u±ibË
(
	`m£cs_to_jiff›s
(1000));

205 
id
 = 
	`©omic64_»ad
(&
wb
->
Ï¡_æushed_£gm’t_id
) + 1;

207 
	`smp_rmb
();

209 
¿mbuf
 = 
	`g‘_¿mbufãr_by_id
(
wb
, 
id
);

210 
£g
 = 
¿mbuf
->seg;

212 #ifdeà
ACACHE


213 
	`´štk
("£g id: %u,„ambuàid: %u, check iØ·‰’: %u\n",
£g
->
id
,id,
	`check_io_·‰”n
(
wb
, seg));

214 ià(!
wb
->
ad­tive_wr™e_mode
) {

215 
io_»q
 = (
dm_io_»que¡
) {

216 
WB_IO_WRITE
,

217 .
ş›Á
 = 
wb
->
io_ş›Á
,

218 .
nÙify
.
â
 = 
NULL
,

219 .
mem
.
ty³
 = 
DM_IO_VMA
,

220 .
mem
.
±r
.
addr
 = 
¿mbuf
->
d©a
,

222 
»giÚ
 = (
dm_io_»giÚ
) {

223 .
bdev
 = 
wb
->
ÿche_dev
->bdev,

224 .
£ùÜ
 = 
£g
->
¡¬t_£ùÜ
,

225 .
couÁ
 = (
£g
->
Ëngth
 + 1) << 3,

228 ià(
	`check_io_·‰”n
(
wb
, 
£g
)) {

229 
	`´štk
("sequential io check!!\n");

230 
	`£qu’tŸl_wr™e
(
wb
, 
¿mbuf
, 
£g
);

232 
	`´štk
("random io check!!\n");

233 
io_»q
 = (
dm_io_»que¡
) {

234 
WB_IO_WRITE
,

235 .
ş›Á
 = 
wb
->
io_ş›Á
,

236 .
nÙify
.
â
 = 
NULL
,

237 .
mem
.
ty³
 = 
DM_IO_VMA
,

238 .
mem
.
±r
.
addr
 = 
¿mbuf
->
d©a
,

240 
»giÚ
 = (
dm_io_»giÚ
) {

241 .
bdev
 = 
wb
->
ÿche_dev
->bdev,

242 .
£ùÜ
 = 
£g
->
¡¬t_£ùÜ
,

243 .
couÁ
 = (
£g
->
Ëngth
 + 1) << 3,

245 ià(
	`wb_io
(&
io_»q
, 1, &
»giÚ
, 
NULL
, 
çl£
))

250 
io_»q
 = (
dm_io_»que¡
) {

251 
WB_IO_WRITE
,

252 .
ş›Á
 = 
wb
->
io_ş›Á
,

253 .
nÙify
.
â
 = 
NULL
,

254 .
mem
.
ty³
 = 
DM_IO_VMA
,

255 .
mem
.
±r
.
addr
 = 
¿mbuf
->
d©a
,

257 
»giÚ
 = (
dm_io_»giÚ
) {

258 .
bdev
 = 
wb
->
ÿche_dev
->bdev,

259 .
£ùÜ
 = 
£g
->
¡¬t_£ùÜ
,

260 .
couÁ
 = (
£g
->
Ëngth
 + 1) << 3,

262 ià(
	`wb_io
(&
io_»q
, 1, &
»giÚ
, 
NULL
, 
çl£
))

271 
	`´oûss_deã¼ed_b¬r›rs
(
wb
, 
¿mbuf
);

277 
	`smp_wmb
();

278 
	`©omic64_šc
(&
wb
->
Ï¡_æushed_£gm’t_id
);

279 
	`wake_up
(&
wb
->
æush_wa™_queue
);

280 
	}
}

282 
	$æush_d«mÚ_´oc
(*
d©a
)

284 
wb_deviû
 *
wb
 = 
d©a
;

285 !
	`kth»ad_should_¡İ
())

286 
	`do_æush_´oc
(
wb
);

288 
	}
}

290 
	$wa™_fÜ_æushšg
(
wb_deviû
 *
wb
, 
u64
 
id
)

292 
	`wa™_ev’t
(
wb
->
æush_wa™_queue
,

293 
	`©omic64_»ad
(&
wb
->
Ï¡_æushed_£gm’t_id
è>ğ
id
);

294 
	`smp_rmb
();

295 
	}
}

299 
	$wr™eback_’dio
(
”rÜ
, *
cÚ‹xt
)

301 
wb_deviû
 *
wb
 = 
cÚ‹xt
;

303 ià(
”rÜ
)

304 
	`©omic_šc
(&
wb
->
wr™eback_ç_couÁ
);

306 ià(
	`©omic_dec_ªd_‹¡
(&
wb
->
wr™eback_io_couÁ
))

307 
	`wake_up
(&
wb
->
wr™eback_io_wa™_queue
);

308 
	}
}

310 
	$subm™_wr™eback_io
(
wb_deviû
 *
wb
, 
wr™eback_io
 *writeback_io)

312 
	`ASSERT
(
wr™eback_io
->
d©a_b™s
 > 0);

314 ià(
wr™eback_io
->
d©a_b™s
 == 255) {

315 
dm_io_»que¡
 
io_»q_w
 = {

316 
WB_IO_WRITE
,

317 .
ş›Á
 = 
wb
->
io_ş›Á
,

318 .
nÙify
.
â
 = 
wr™eback_’dio
,

319 .
nÙify
.
cÚ‹xt
 = 
wb
,

320 .
mem
.
ty³
 = 
DM_IO_VMA
,

321 .
mem
.
±r
.
addr
 = 
wr™eback_io
->
d©a
,

323 
dm_io_»giÚ
 
»giÚ_w
 = {

324 .
bdev
 = 
wb
->
backšg_dev
->bdev,

325 .
£ùÜ
 = 
wr™eback_io
->sector,

326 .
couÁ
 = 1 << 3,

328 ià(
	`wb_io
(&
io_»q_w
, 1, &
»giÚ_w
, 
NULL
, 
çl£
))

329 
	`wr™eback_’dio
(1, 
wb
);

331 
u8
 
i
;

332 
i
 = 0; i < 8; i++) {

333 
dm_io_»que¡
 
io_»q_w
;

334 
dm_io_»giÚ
 
»giÚ_w
;

336 
boŞ
 
b™_Ú
 = 
wr™eback_io
->
d©a_b™s
 & (1 << 
i
);

337 ià(!
b™_Ú
)

340 
io_»q_w
 = (
dm_io_»que¡
) {

341 
WB_IO_WRITE
,

342 .
ş›Á
 = 
wb
->
io_ş›Á
,

343 .
nÙify
.
â
 = 
wr™eback_’dio
,

344 .
nÙify
.
cÚ‹xt
 = 
wb
,

345 .
mem
.
ty³
 = 
DM_IO_VMA
,

346 .
mem
.
±r
.
addr
 = 
wr™eback_io
->
d©a
 + (
i
 << 9),

348 
»giÚ_w
 = (
dm_io_»giÚ
) {

349 .
bdev
 = 
wb
->
backšg_dev
->bdev,

350 .
£ùÜ
 = 
wr™eback_io
->£ùÜ + 
i
,

351 .
couÁ
 = 1,

353 ià(
	`wb_io
(&
io_»q_w
, 1, &
»giÚ_w
, 
NULL
, 
çl£
))

354 
	`wr™eback_’dio
(1, 
wb
);

357 
	}
}

359 
	$subm™_wr™eback_ios
(
wb_deviû
 *
wb
)

361 
blk_¶ug
 
¶ug
;

362 
rb_roÙ
 
wt
 = 
wb
->
wr™eback_Œ“
;

363 
	`blk_¡¬t_¶ug
(&
¶ug
);

364 !
	`RB_EMPTY_ROOT
(&
wt
)) {

365 
wr™eback_io
 *wr™eback_iØğ
	`wr™eback_io_äom_node
(
	`rb_fœ¡
(&
wt
));

366 
	`rb_”a£
(&
wr™eback_io
->
rb_node
, &
wt
);

367 
	`subm™_wr™eback_io
(
wb
, 
wr™eback_io
);

369 
	`blk_fšish_¶ug
(&
¶ug
);

370 
	}
}

380 
boŞ
 
	$com·»_wr™eback_io
(
wr™eback_io
 *
a
, wr™eback_iØ*
b
)

382 
	`ASSERT
(
a
);

383 
	`ASSERT
(
b
);

384 ià(
a
->
£ùÜ
 < 
b
->sector)

385  
Œue
;

386 ià(
a
->
id
 < 
b
->id)

387  
Œue
;

388  
çl£
;

389 
	}
}

391 
	$šc_wr™eback_io_couÁ
(
u8
 
d©a_b™s
, 
size_t
 *
wr™eback_io_couÁ
)

393 ià(
d©a_b™s
 == 255) {

394 (*
wr™eback_io_couÁ
)++;

396 
u8
 
i
;

397 
i
 = 0; i < 8; i++) {

398 ià(
d©a_b™s
 & (1 << 
i
))

399 (*
wr™eback_io_couÁ
)++;

402 
	}
}

408 
	$add_wr™eback_io
(
wb_deviû
 *
wb
, 
wr™eback_io
 *writeback_io)

410 
rb_node
 **
rbp
, *
·»Á
;

411 
rbp
 = &
wb
->
wr™eback_Œ“
.
rb_node
;

412 
·»Á
 = 
NULL
;

413 *
rbp
) {

414 
wr™eback_io
 *
·»Á_io
;

415 
·»Á
 = *
rbp
;

416 
·»Á_io
 = 
	`wr™eback_io_äom_node
(
·»Á
);

418 ià(
	`com·»_wr™eback_io
(
wr™eback_io
, 
·»Á_io
))

419 
rbp
 = &(*rbp)->
rb_Ëá
;

421 
rbp
 = &(*rbp)->
rb_right
;

423 
	`rb_lšk_node
(&
wr™eback_io
->
rb_node
, 
·»Á
, 
rbp
);

424 
	`rb_š£¹_cŞÜ
(&
wr™eback_io
->
rb_node
, &
wb
->
wr™eback_Œ“
);

425 
	}
}

427 
	$fl_wr™eback_£g
(
wb_deviû
 *
wb
, 
wr™eback_£gm’t
 *
wr™eback_£g
)

429 
£gm’t_h—d”
 *
£g
 = 
wr™eback_£g
->seg;

431 
dm_io_»que¡
 
io_»q_r
 = {

432 
WB_IO_READ
,

433 .
ş›Á
 = 
wb
->
io_ş›Á
,

434 .
nÙify
.
â
 = 
NULL
,

435 .
mem
.
ty³
 = 
DM_IO_VMA
,

436 .
mem
.
±r
.
addr
 = 
wr™eback_£g
->
buf
,

438 
dm_io_»giÚ
 
»giÚ_r
 = {

439 .
bdev
 = 
wb
->
ÿche_dev
->bdev,

440 .
£ùÜ
 = 
£g
->
¡¬t_£ùÜ
 + (1 << 3),

441 .
couÁ
 = 
£g
->
Ëngth
 << 3,

448  
	`wb_io
(&
io_»q_r
, 1, &
»giÚ_r
, 
NULL
, 
çl£
);

449 
	}
}

451 
	$´•¬e_wr™eback_ios
(
wb_deviû
 *
wb
, 
wr™eback_£gm’t
 *
wr™eback_£g
,

452 
size_t
 *
wr™eback_io_couÁ
)

454 
£gm’t_h—d”
 *
£g
 = 
wr™eback_£g
->seg;

456 
u8
 
i
;

457 
i
 = 0; i < 
£g
->
Ëngth
; i++) {

458 
wr™eback_io
 *writeback_io;

460 
m‘ablock
 *
mb
 = 
£g
->
mb_¬¿y
 + 
i
;

461 
dœtšess
 dœtšes ğ
	`»ad_mb_dœtšess
(
wb
, 
£g
, 
mb
);

462 
	`ASSERT
(
dœtšess
.
d©a_b™s
 > 0);

464 ià(!
dœtšess
.
is_dœty
)

467 
wr™eback_io
 = 
wr™eback_£g
->
ios
 + 
i
;

468 
wr™eback_io
->
£ùÜ
 = 
mb
->sector;

469 
wr™eback_io
->
id
 = 
£g
->id;

471 
wr™eback_io
->
d©a_b™s
 = 
dœtšess
.data_bits;

473 
	`šc_wr™eback_io_couÁ
(
wr™eback_io
->
d©a_b™s
, 
wr™eback_io_couÁ
);

474 
	`add_wr™eback_io
(
wb
, 
wr™eback_io
);

476 
	}
}

478 
	$m¬k_ş—n_£g
(
wb_deviû
 *
wb
, 
£gm’t_h—d”
 *
£g
)

480 
u8
 
i
;

481 
i
 = 0; i < 
£g
->
Ëngth
; i++) {

482 
m‘ablock
 *
mb
 = 
£g
->
mb_¬¿y
 + 
i
;

483 ià(
	`m¬k_ş—n_mb
(
wb
, 
mb
))

484 
	`dec_Ä_dœty_ÿches
(
wb
);

486 
	}
}

491 
boŞ
 
	$Œy_wr™eback_£gs
(
wb_deviû
 *
wb
)

493 
wr™eback_£gm’t
 *
wr™eback_£g
;

494 
size_t
 
wr™eback_io_couÁ
 = 0;

495 
u32
 
k
;

498 
wb
->
wr™eback_Œ“
 = 
RB_ROOT
;

499 
k
 = 0; k < 
wb
->
Ä_cur_b©ched_wr™eback
; k++) {

500 
wr™eback_£g
 = *(
wb
->
wr™eback_£gs
 + 
k
);

502 ià(
	`fl_wr™eback_£g
(
wb
, 
wr™eback_£g
))

503  
çl£
;

505 
	`´•¬e_wr™eback_ios
(
wb
, 
wr™eback_£g
, &
wr™eback_io_couÁ
);

508 
	`©omic_£t
(&
wb
->
wr™eback_io_couÁ
, writeback_io_count);

509 
	`©omic_£t
(&
wb
->
wr™eback_ç_couÁ
, 0);

512 
	`subm™_wr™eback_ios
(
wb
);

513 
	`wa™_ev’t
(
wb
->
wr™eback_io_wa™_queue
, !
	`©omic_»ad
(&wb->
wr™eback_io_couÁ
));

515  
	`©omic_»ad
(&
wb
->
wr™eback_ç_couÁ
) == 0;

516 
	}
}

518 
boŞ
 
	$do_wr™eback_£gs
(
wb_deviû
 *
wb
)

520 ià(!
	`Œy_wr™eback_£gs
(
wb
))

521  
çl£
;

523 
	`blkdev_issue_æush
(
wb
->
backšg_dev
->
bdev
, 
GFP_NOIO
, 
NULL
);

524  
Œue
;

525 
	}
}

530 
	$upd©e_Ä_em±y_£gs
(
wb_deviû
 *
wb
)

533 
wb
->
Ä_em±y_£gs
 =

534 
	`©omic64_»ad
(&
wb
->
Ï¡_wr™eback_£gm’t_id
è+ wb->
Ä_£gm’ts


535 - 
wb
->
cu¼’t_£g
->
id
;

536 
	}
}

539 
u32
 
	$ÿlc_Ä_wr™eback
(
wb_deviû
 *
wb
)

541 
u32
 
Ä_wr™eback_ÿndid©es
 =

542 
	`©omic64_»ad
(&
wb
->
Ï¡_æushed_£gm’t_id
)

543 - 
	`©omic64_»ad
(&
wb
->
Ï¡_wr™eback_£gm’t_id
);

546 
u32
 
Ä_max_b©ch
 = 
	`ACCESS_ONCE
(
wb
->
Ä_max_b©ched_wr™eback
);

547 ià(
wb
->
Ä_wr™eback_£gs
 !ğ
Ä_max_b©ch
)

548 
	`Œy_®loc_wr™eback_ios
(
wb
, 
Ä_max_b©ch
, 
GFP_NOIO
 | 
__GFP_NOWARN
);

555  
	`mš3
(
Ä_wr™eback_ÿndid©es
, 
wb
->
Ä_wr™eback_£gs
, wb->
Ä_em±y_£gs
 + 1);

556 
	}
}

558 
boŞ
 
	$should_wr™eback
(
wb_deviû
 *
wb
)

560  
	`ACCESS_ONCE
(
wb
->
®low_wr™eback
) ||

561 
	`ACCESS_ONCE
(
wb
->
urge_wr™eback
) ||

562 
	`ACCESS_ONCE
(
wb
->
fÜû_drİ
);

563 
	}
}

565 
	$do_wr™eback_´oc
(
wb_deviû
 *
wb
)

567 
u32
 
k
, 
Ä_wr™eback_tbd
;

569 ià(!
	`should_wr™eback
(
wb
)) {

570 
	`scheduË_timeout_š‹¼u±ibË
(
	`m£cs_to_jiff›s
(1000));

574 
Ä_wr™eback_tbd
 = 
	`ÿlc_Ä_wr™eback
(
wb
);

575 ià(!
Ä_wr™eback_tbd
) {

576 
	`scheduË_timeout_š‹¼u±ibË
(
	`m£cs_to_jiff›s
(1000));

580 
	`smp_rmb
();

583 
k
 = 0; k < 
Ä_wr™eback_tbd
; k++) {

584 
wr™eback_£gm’t
 *
wr™eback_£g
 = *(
wb
->
wr™eback_£gs
 + 
k
);

585 
wr™eback_£g
->
£g
 = 
	`g‘_£gm’t_h—d”_by_id
(
wb
,

586 
	`©omic64_»ad
(&
wb
->
Ï¡_wr™eback_£gm’t_id
è+ 1 + 
k
);

588 
wb
->
Ä_cur_b©ched_wr™eback
 = 
Ä_wr™eback_tbd
;

590 ià(!
	`do_wr™eback_£gs
(
wb
))

594 
k
 = 0; k < 
wb
->
Ä_cur_b©ched_wr™eback
; k++) {

595 
wr™eback_£gm’t
 *
wr™eback_£g
 = *(
wb
->
wr™eback_£gs
 + 
k
);

596 
	`m¬k_ş—n_£g
(
wb
, 
wr™eback_£g
->
£g
);

599 
	`smp_wmb
();

600 
	`©omic64_add
(
wb
->
Ä_cur_b©ched_wr™eback
, &wb->
Ï¡_wr™eback_£gm’t_id
);

601 
	`wake_up
(&
wb
->
wr™eback_wa™_queue
);

602 
	}
}

604 
	$wr™eback_d«mÚ_´oc
(*
d©a
)

606 
wb_deviû
 *
wb
 = 
d©a
;

607 !
	`kth»ad_should_¡İ
())

608 
	`do_wr™eback_´oc
(
wb
);

610 
	}
}

616 
	$wa™_fÜ_wr™eback
(
wb_deviû
 *
wb
, 
u64
 
id
)

618 ià(
	`©omic64_»ad
(&
wb
->
Ï¡_wr™eback_£gm’t_id
è< 
id
) {

619 
wb
->
urge_wr™eback
 = 
Œue
;

620 
	`wake_up_´oûss
(
wb
->
wr™eback_d«mÚ
);

621 
	`wa™_ev’t
(
wb
->
wr™eback_wa™_queue
,

622 
	`©omic64_»ad
(&
wb
->
Ï¡_wr™eback_£gm’t_id
è>ğ
id
);

623 
wb
->
urge_wr™eback
 = 
çl£
;

625 
	`smp_rmb
();

626 
	}
}

630 
	$wr™eback_moduÏtÜ_´oc
(*
d©a
)

632 
wb_deviû
 *
wb
 = 
d©a
;

634 
hd_¡ruù
 *
hd
 = 
wb
->
backšg_dev
->
bdev
->
bd_·¹
;

635 
Şd
 = 0, 
Ãw
, 
ut
;

636 
štvl
 = 1000;

638 !
	`kth»ad_should_¡İ
()) {

639 
Ãw
 = 
	`jiff›s_to_m£cs
(
	`·¹_¡©_»ad
(
hd
, 
io_ticks
));

641 
ut
 = 
	`div_u64
(100 * (
Ãw
 - 
Şd
), 1000);

643 ià(
ut
 < 
	`ACCESS_ONCE
(
wb
->
wr™eback_th»shŞd
))

644 
wb
->
®low_wr™eback
 = 
Œue
;

646 
wb
->
®low_wr™eback
 = 
çl£
;

648 
Şd
 = 
Ãw
;

650 
	`upd©e_Ä_em±y_£gs
(
wb
);

652 
	`scheduË_timeout_š‹¼u±ibË
(
	`m£cs_to_jiff›s
(
štvl
));

655 
	}
}

659 
	$upd©e_su³rblock_»cÜd
(
wb_deviû
 *
wb
)

661 
su³rblock_»cÜd_deviû
 
o
;

662 *
buf
;

663 
dm_io_»que¡
 
io_»q
;

664 
dm_io_»giÚ
 
»giÚ
;

666 
o
.
Ï¡_wr™eback_£gm’t_id
 =

667 
	`ıu_to_Ë64
(
	`©omic64_»ad
(&
wb
->
Ï¡_wr™eback_£gm’t_id
));

669 
buf
 = 
	`mempoŞ_®loc
(
wb
->
buf_8_poŞ
, 
GFP_NOIO
);

670 ià(!
buf
)

673 
	`mem£t
(
buf
, 0, 8 << 9);

674 
	`memıy
(
buf
 + (7 << 9), &
o
, (o));

676 
io_»q
 = (
dm_io_»que¡
) {

677 
WB_IO_WRITE_FUA
,

678 .
ş›Á
 = 
wb
->
io_ş›Á
,

679 .
nÙify
.
â
 = 
NULL
,

680 .
mem
.
ty³
 = 
DM_IO_KMEM
,

681 .
mem
.
±r
.
addr
 = 
buf
,

683 
»giÚ
 = (
dm_io_»giÚ
) {

684 .
bdev
 = 
wb
->
ÿche_dev
->bdev,

685 .
£ùÜ
 = (1 << 11) - 8,

686 .
couÁ
 = 8,

688 
	`wb_io
(&
io_»q
, 1, &
»giÚ
, 
NULL
, 
çl£
);

690 
	`mempoŞ_ä“
(
buf
, 
wb
->
buf_8_poŞ
);

691 
	}
}

693 
	$sb_»cÜd_upd©”_´oc
(*
d©a
)

695 
wb_deviû
 *
wb
 = 
d©a
;

697 
štvl
;

699 !
	`kth»ad_should_¡İ
()) {

701 
štvl
 = 
	`ACCESS_ONCE
(
wb
->
upd©e_sb_»cÜd_š‹rv®
) * 1000;

703 ià(!
štvl
) {

704 
	`scheduË_timeout_š‹¼u±ibË
(
	`m£cs_to_jiff›s
(1000));

708 
	`upd©e_su³rblock_»cÜd
(
wb
);

709 
	`scheduË_timeout_š‹¼u±ibË
(
	`m£cs_to_jiff›s
(
štvl
));

712 
	}
}

716 
	$d©a_synchrÚiz”_´oc
(*
d©a
)

718 
wb_deviû
 *
wb
 = 
d©a
;

719 
štvl
;

721 !
	`kth»ad_should_¡İ
()) {

723 
štvl
 = 
	`ACCESS_ONCE
(
wb
->
sync_d©a_š‹rv®
) * 1000;

725 ià(!
štvl
) {

726 
	`scheduË_timeout_š‹¼u±ibË
(
	`m£cs_to_jiff›s
(1000));

730 
	`æush_cu¼’t_bufãr
(
wb
);

731 
	`blkdev_issue_æush
(
wb
->
ÿche_dev
->
bdev
, 
GFP_NOIO
, 
NULL
);

732 
	`scheduË_timeout_š‹¼u±ibË
(
	`m£cs_to_jiff›s
(
štvl
));

735 
	}
}

	@dm-writeboost-daemon.h

20 #iâdeà
DM_WRITEBOOST_DAEMON_H


21 
	#DM_WRITEBOOST_DAEMON_H


	)

25 
æush_d«mÚ_´oc
(*);

26 
wa™_fÜ_æushšg
(
wb_deviû
 *, 
u64
 
id
);

30 
queue_b¬r›r_io
(
wb_deviû
 *, 
bio
 *);

31 
æush_b¬r›r_ios
(
wÜk_¡ruù
 *);

35 
upd©e_Ä_em±y_£gs
(
wb_deviû
 *);

36 
wr™eback_d«mÚ_´oc
(*);

37 
wa™_fÜ_wr™eback
(
wb_deviû
 *, 
u64
 
id
);

38 
m¬k_ş—n_£g
(
wb_deviû
 *, 
£gm’t_h—d”
 *
£g
);

45 
wr™eback_moduÏtÜ_´oc
(*);

49 
d©a_synchrÚiz”_´oc
(*);

53 
sb_»cÜd_upd©”_´oc
(*);

	@dm-writeboost-metadata.c

20 
	~"dm-wr™eboo¡.h
"

21 
	~"dm-wr™eboo¡-m‘ad©a.h
"

22 
	~"dm-wr™eboo¡-d«mÚ.h
"

26 
	sÏrge_¬¿y
 {

27 
u64
 
	mÄ_–ems
;

28 
u32
 
	m–emsize
;

29 *
	md©a
;

32 
Ïrge_¬¿y
 *
	$Ïrge_¬¿y_®loc
(
u32
 
–emsize
, 
u64
 
Ä_–ems
)

34 
Ïrge_¬¿y
 *
¬r
 = 
	`km®loc
((*¬r), 
GFP_KERNEL
);

35 ià(!
¬r
) {

36 
	`DMERR
("Failedo‡llocate‡rr");

37  
NULL
;

41 
¬r
->
–emsize
 =ƒlemsize;

42 
¬r
->
Ä_–ems
 =‚r_elems;

44 
¬r
->
d©a
 = 
	`vm®loc
(
–emsize
 * 
Ä_–ems
);

45 ià(!
¬r
->
d©a
) {

46 
	`DMERR
("Failedo‡llocate data");

47 
bad_®loc_d©a
;

50  
¬r
;

52 
bad_®loc_d©a
:

53 
	`kä“
(
¬r
);

54  
NULL
;

55 
	}
}

57 
	$Ïrge_¬¿y_ä“
(
Ïrge_¬¿y
 *
¬r
)

59 
	`vä“
(
¬r
->
d©a
);

60 
	`kä“
(
¬r
);

61 
	}
}

63 *
	$Ïrge_¬¿y_©
(
Ïrge_¬¿y
 *
¬r
, 
u64
 
i
)

66  
¬r
->
d©a
 +‡¼->
–emsize
 * 
i
;

67 
	}
}

74 
m‘ablock
 *
	$mb_©
(
wb_deviû
 *
wb
, 
u32
 
idx
)

76 
u32
 
idx_š£g
;

77 
u32
 
£g_idx
 = 
	`div_u64_»m
(
idx
, 
wb
->
Ä_ÿches_š£g
, &
idx_š£g
);

78 
£gm’t_h—d”
 *
£g
 = 
	`Ïrge_¬¿y_©
(
wb
->
£gm’t_h—d”_¬¿y
, 
£g_idx
);

79  
£g
->
mb_¬¿y
 + 
idx_š£g
;

80 
	}
}

82 
	$mb_¬¿y_em±y_š™
(
wb_deviû
 *
wb
)

84 
u32
 
i
;

85 
i
 = 0; i < 
wb
->
Ä_ÿches
; i++) {

86 
m‘ablock
 *
mb
 = 
	`mb_©
(
wb
, 
i
);

87 
	`INIT_HLIST_NODE
(&
mb
->
ht_li¡
);

89 
mb
->
idx
 = 
i
;

90 
mb
->
dœtšess
.
d©a_b™s
 = 0;

91 
mb
->
dœtšess
.
is_dœty
 = 
çl£
;

93 
	}
}

98 
£ùÜ_t
 
	$ÿlc_£gm’t_h—d”_¡¬t
(
wb_deviû
 *
wb
, 
u32
 
k
)

100  (1 << 11è+ (1 << 
SEGMENT_SIZE_ORDER
è* 
k
;

101 
	}
}

103 
u32
 
	$ÿlc_Ä_£gm’ts
(
dm_dev
 *
dev
, 
wb_deviû
 *
wb
)

105 
£ùÜ_t
 
devsize
 = 
	`dm_devsize
(
dev
);

106  
	`div_u64
(
devsize
 - (1 << 11), 1 << 
SEGMENT_SIZE_ORDER
);

107 
	}
}

114 
u8
 
	$mb_idx_š£g
(
wb_deviû
 *
wb
, 
u32
 
mb_idx
)

116 
u32
 
tmp32
;

118 
	`div_u64_»m
(
mb_idx
, 
wb
->
Ä_ÿches_š£g
, &
tmp32
);

119  
tmp32
;

120 
	}
}

125 
£ùÜ_t
 
	$ÿlc_mb_¡¬t_£ùÜ
(
wb_deviû
 *
wb
, 
£gm’t_h—d”
 *
£g
, 
u32
 
mb_idx
)

127  
£g
->
¡¬t_£ùÜ
 + ((1 + 
	`mb_idx_š£g
(
wb
, 
mb_idx
)) << 3);

128 
	}
}

133 
£gm’t_h—d”
 *
	$mb_to_£g
(
wb_deviû
 *
wb
, 
m‘ablock
 *
mb
)

135 
£gm’t_h—d”
 *
£g
;

136 
£g
 = ((*è
mb
)

137 - 
	`mb_idx_š£g
(
wb
, 
mb
->
idx
è* (
m‘ablock
)

138 - (
£gm’t_h—d”
);

139  
£g
;

140 
	}
}

142 
boŞ
 
	$is_Ú_bufãr
(
wb_deviû
 *
wb
, 
u32
 
mb_idx
)

144 
u32
 
¡¬t
 = 
wb
->
cu¼’t_£g
->
¡¬t_idx
;

145 ià(
mb_idx
 < 
¡¬t
)

146  
çl£
;

148 ià(
mb_idx
 >ğ(
¡¬t
 + 
wb
->
Ä_ÿches_š£g
))

149  
çl£
;

151  
Œue
;

152 
	}
}

154 
u32
 
	$£gm’t_id_to_idx
(
wb_deviû
 *
wb
, 
u64
 
id
)

156 
u32
 
idx
;

157 
	`div_u64_»m
(
id
 - 1, 
wb
->
Ä_£gm’ts
, &
idx
);

158  
idx
;

159 
	}
}

161 
£gm’t_h—d”
 *
	$£gm’t_©
(
wb_deviû
 *
wb
, 
u32
 
k
)

163  
	`Ïrge_¬¿y_©
(
wb
->
£gm’t_h—d”_¬¿y
, 
k
);

164 
	}
}

170 
£gm’t_h—d”
 *
	$g‘_£gm’t_h—d”_by_id
(
wb_deviû
 *
wb
, 
u64
 
id
)

172  
	`£gm’t_©
(
wb
, 
	`£gm’t_id_to_idx
(wb, 
id
));

173 
	}
}

177 
	$š™_£gm’t_h—d”_¬¿y
(
wb_deviû
 *
wb
)

179 
u32
 
£gm’t_idx
;

181 
wb
->
£gm’t_h—d”_¬¿y
 = 
	`Ïrge_¬¿y_®loc
(

182 (
£gm’t_h—d”
) +

183 (
m‘ablock
è* 
wb
->
Ä_ÿches_š£g
,

184 
wb
->
Ä_£gm’ts
);

185 ià(!
wb
->
£gm’t_h—d”_¬¿y
) {

186 
	`DMERR
("Failedo‡llocate segment_header_array");

187  -
ENOMEM
;

190 
£gm’t_idx
 = 0; segm’t_idx < 
wb
->
Ä_£gm’ts
; segment_idx++) {

191 
£gm’t_h—d”
 *
£g
 = 
	`Ïrge_¬¿y_©
(
wb
->
£gm’t_h—d”_¬¿y
, 
£gm’t_idx
);

193 
£g
->
id
 = 0;

194 
£g
->
Ëngth
 = 0;

195 
	`©omic_£t
(&
£g
->
Ä_šæight_ios
, 0);

198 
£g
->
¡¬t_idx
 = 
wb
->
Ä_ÿches_š£g
 * 
£gm’t_idx
;

199 
£g
->
¡¬t_£ùÜ
 = 
	`ÿlc_£gm’t_h—d”_¡¬t
(
wb
, 
£gm’t_idx
);

202 
	`mb_¬¿y_em±y_š™
(
wb
);

205 
	}
}

207 
	$ä“_£gm’t_h—d”_¬¿y
(
wb_deviû
 *
wb
)

209 
	`Ïrge_¬¿y_ä“
(
wb
->
£gm’t_h—d”_¬¿y
);

210 
	}
}

214 
	sht_h—d
 {

215 
hli¡_h—d
 
	mht_li¡
;

218 
	$ht_em±y_š™
(
wb_deviû
 *
wb
)

220 
u32
 
idx
;

221 
size_t
 
i
, 
Ä_h—ds
;

222 
Ïrge_¬¿y
 *
¬r
;

224 
wb
->
htsize
 = wb->
Ä_ÿches
;

225 
Ä_h—ds
 = 
wb
->
htsize
 + 1;

226 
¬r
 = 
	`Ïrge_¬¿y_®loc
((
ht_h—d
), 
Ä_h—ds
);

227 ià(!
¬r
) {

228 
	`DMERR
("Failedo‡llocate htable");

229  -
ENOMEM
;

233 
wb
->
hbË
 = 
¬r
;

235 
i
 = 0; i < 
Ä_h—ds
; i++) {

236 
ht_h—d
 *
hd
 = 
	`Ïrge_¬¿y_©
(
¬r
, 
i
);

237 
	`INIT_HLIST_HEAD
(&
hd
->
ht_li¡
);

240 
wb
->
nuÎ_h—d
 = 
	`Ïrge_¬¿y_©
(wb->
hbË
, wb->
htsize
);

242 
idx
 = 0; idx < 
wb
->
Ä_ÿches
; idx++) {

243 
m‘ablock
 *
mb
 = 
	`mb_©
(
wb
, 
idx
);

244 
	`hli¡_add_h—d
(&
mb
->
ht_li¡
, &
wb
->
nuÎ_h—d
->ht_list);

249 
	}
}

251 
	$ä“_ht
(
wb_deviû
 *
wb
)

253 
	`Ïrge_¬¿y_ä“
(
wb
->
hbË
);

254 
	}
}

256 
ht_h—d
 *
	$ht_g‘_h—d
(
wb_deviû
 *
wb
, 
lookup_key
 *
key
)

258 
u32
 
idx
;

260 
	`div_u64_»m
(
key
->
£ùÜ
 >> 3, 
wb
->
htsize
, &
idx
);

261  
	`Ïrge_¬¿y_©
(
wb
->
hbË
, 
idx
);

262 
	}
}

264 
boŞ
 
	$mb_h™
(
m‘ablock
 *
mb
, 
lookup_key
 *
key
)

266  
mb
->
£ùÜ
 =ğ
key
->sector;

267 
	}
}

272 
	$ht_d–
(
wb_deviû
 *
wb
, 
m‘ablock
 *
mb
)

274 
ht_h—d
 *
nuÎ_h—d
;

276 
	`hli¡_d–
(&
mb
->
ht_li¡
);

278 
nuÎ_h—d
 = 
wb
->null_head;

279 
	`hli¡_add_h—d
(&
mb
->
ht_li¡
, &
nuÎ_h—d
->ht_list);

280 
	}
}

282 
	$ht_»gi¡”
(
wb_deviû
 *
wb
, 
ht_h—d
 *
h—d
,

283 
m‘ablock
 *
mb
, 
lookup_key
 *
key
)

285 
	`hli¡_d–
(&
mb
->
ht_li¡
);

286 
	`hli¡_add_h—d
(&
mb
->
ht_li¡
, &
h—d
->ht_list);

288 
	`BUG_ON
(
key
->
£ùÜ
 & 7);

289 
mb
->
£ùÜ
 = 
key
->sector;

290 
	}
};

292 
m‘ablock
 *
	$ht_lookup
(
wb_deviû
 *
wb
, 
ht_h—d
 *
h—d
,

293 
lookup_key
 *
key
)

295 
m‘ablock
 *
mb
, *
found
 = 
NULL
;

297 
	`hli¡_fÜ_—ch_’Œy
(
mb
, &
h—d
->
ht_li¡
, ht_list) {

298 ià(
	`mb_h™
(
mb
, 
key
)) {

299 
found
 = 
mb
;

303  
found
;

304 
	}
}

309 
	$disÿrd_ÿches_š£g
(
wb_deviû
 *
wb
, 
£gm’t_h—d”
 *
£g
)

311 
u8
 
i
;

312 
i
 = 0; i < 
wb
->
Ä_ÿches_š£g
; i++) {

313 
m‘ablock
 *
mb
 = 
£g
->
mb_¬¿y
 + 
i
;

314 
	`ht_d–
(
wb
, 
mb
);

316 
	}
}

320 
	$»ad_su³rblock_h—d”
(
su³rblock_h—d”_deviû
 *
sup
,

321 
wb_deviû
 *
wb
)

323 
”r
 = 0;

324 
dm_io_»que¡
 
io_»q_sup
;

325 
dm_io_»giÚ
 
»giÚ_sup
;

327 *
buf
 = 
	`mempoŞ_®loc
(
wb
->
buf_8_poŞ
, 
GFP_KERNEL
);

328 ià(!
buf
)

329  -
ENOMEM
;

330 
	`check_bufãr_®ignm’t
(
buf
);

332 
io_»q_sup
 = (
dm_io_»que¡
) {

333 
WB_IO_READ
,

334 .
ş›Á
 = 
wb
->
io_ş›Á
,

335 .
nÙify
.
â
 = 
NULL
,

336 .
mem
.
ty³
 = 
DM_IO_KMEM
,

337 .
mem
.
±r
.
addr
 = 
buf
,

339 
»giÚ_sup
 = (
dm_io_»giÚ
) {

340 .
bdev
 = 
wb
->
ÿche_dev
->bdev,

341 .
£ùÜ
 = 0,

342 .
couÁ
 = 8,

344 
”r
 = 
	`wb_io
(&
io_»q_sup
, 1, &
»giÚ_sup
, 
NULL
, 
çl£
);

345 ià(
”r
)

346 
bad_io
;

348 
	`memıy
(
sup
, 
buf
, (*sup));

350 
bad_io
:

351 
	`mempoŞ_ä“
(
buf
, 
wb
->
buf_8_poŞ
);

352  
”r
;

353 
	}
}

359 
	$aud™_ÿche_deviû
(
wb_deviû
 *
wb
)

361 
”r
 = 0;

362 
su³rblock_h—d”_deviû
 
sup
;

363 
”r
 = 
	`»ad_su³rblock_h—d”
(&
sup
, 
wb
);

364 ià(
”r
) {

365 
	`DMERR
("read_superblock_header failed");

366  
”r
;

369 
wb
->
do_fÜm©
 = 
çl£
;

370 ià(
	`Ë32_to_ıu
(
sup
.
magic
è!ğ
WB_MAGIC
 ||

371 
wb
->
wr™e_¬ound_mode
) {

372 
wb
->
do_fÜm©
 = 
Œue
;

373 
	`DMERR
("Superblock Header: Magic‚umber invalid");

377  
”r
;

378 
	}
}

380 
	$fÜm©_su³rblock_h—d”
(
wb_deviû
 *
wb
)

382 
”r
 = 0;

384 
dm_io_»que¡
 
io_»q_sup
;

385 
dm_io_»giÚ
 
»giÚ_sup
;

387 
su³rblock_h—d”_deviû
 
sup
 = {

388 .
magic
 = 
	`ıu_to_Ë32
(
WB_MAGIC
),

391 *
buf
 = 
	`mempoŞ_®loc
(
wb
->
buf_8_poŞ
, 
GFP_KERNEL
);

392 ià(!
buf
)

393  -
ENOMEM
;

395 
	`mem£t
(
buf
, 0, 8 << 9);

396 
	`memıy
(
buf
, &
sup
, (sup));

398 
io_»q_sup
 = (
dm_io_»que¡
) {

399 
WB_IO_WRITE_FUA
,

400 .
ş›Á
 = 
wb
->
io_ş›Á
,

401 .
nÙify
.
â
 = 
NULL
,

402 .
mem
.
ty³
 = 
DM_IO_KMEM
,

403 .
mem
.
±r
.
addr
 = 
buf
,

405 
»giÚ_sup
 = (
dm_io_»giÚ
) {

406 .
bdev
 = 
wb
->
ÿche_dev
->bdev,

407 .
£ùÜ
 = 0,

408 .
couÁ
 = 8,

410 
”r
 = 
	`wb_io
(&
io_»q_sup
, 1, &
»giÚ_sup
, 
NULL
, 
çl£
);

411 ià(
”r
)

412 
bad_io
;

414 
bad_io
:

415 
	`mempoŞ_ä“
(
buf
, 
wb
->
buf_8_poŞ
);

416  
”r
;

417 
	}
}

419 
	sfÜm©_£gmd_cÚ‹xt
 {

420 
	m”r
;

421 
©omic64_t
 
	mcouÁ
;

424 
	$fÜm©_£gmd_’dio
(
”rÜ
, *
__cÚ‹xt
)

426 
fÜm©_£gmd_cÚ‹xt
 *
cÚ‹xt
 = 
__cÚ‹xt
;

427 ià(
”rÜ
)

428 
cÚ‹xt
->
”r
 = 1;

429 
	`©omic64_dec
(&
cÚ‹xt
->
couÁ
);

430 
	}
}

432 
	sz”ošg_cÚ‹xt
 {

433 
	m”rÜ
;

434 
com¶‘iÚ
 
	mcom¶‘e
;

437 
	$z”ošg_com¶‘e
(
»ad_”r
, 
wr™e_”r
, *
cÚ‹xt
)

439 
z”ošg_cÚ‹xt
 *
zc
 = 
cÚ‹xt
;

440 ià(
»ad_”r
 || 
wr™e_”r
)

441 
zc
->
”rÜ
 = -
EIO
;

442 
	`com¶‘e
(&
zc
->
com¶‘e
);

443 
	}
}

448 
	$do_z”ošg_»giÚ
(
wb_deviû
 *
wb
, 
dm_io_»giÚ
 *
»giÚ
)

450 
”r
;

451 
z”ošg_cÚ‹xt
 
zc
;

452 
zc
.
”rÜ
 = 0;

453 
	`š™_com¶‘iÚ
(&
zc
.
com¶‘e
);

454 
”r
 = 
	`dm_kcİyd_z”o
(
wb
->
cİ›r
, 1, 
»giÚ
, 0, 
z”ošg_com¶‘e
, &
zc
);

455 ià(
”r
)

456  
”r
;

457 
	`wa™_fÜ_com¶‘iÚ
(&
zc
.
com¶‘e
);

458  
zc
.
”rÜ
;

459 
	}
}

461 
	$z”ošg_fuÎ_su³rblock
(
wb_deviû
 *
wb
)

463 
dm_io_»giÚ
 
»giÚ
 = {

464 .
bdev
 = 
wb
->
ÿche_dev
->bdev,

465 .
£ùÜ
 = 0,

466 .
couÁ
 = 1 << 11,

468  
	`do_z”ošg_»giÚ
(
wb
, &
»giÚ
);

469 
	}
}

471 
	$fÜm©_®l_£gm’t_h—d”s
(
wb_deviû
 *
wb
)

473 
”r
 = 0;

474 
dm_dev
 *
dev
 = 
wb
->
ÿche_dev
;

475 
u32
 
i
;

477 
fÜm©_£gmd_cÚ‹xt
 
cÚ‹xt
;

479 *
buf
 = 
	`mempoŞ_®loc
(
wb
->
buf_8_poŞ
, 
GFP_KERNEL
);

480 ià(!
buf
)

481  -
ENOMEM
;

483 
	`mem£t
(
buf
, 0, 8 << 9);

484 
	`check_bufãr_®ignm’t
(
buf
);

486 
	`©omic64_£t
(&
cÚ‹xt
.
couÁ
, 
wb
->
Ä_£gm’ts
);

487 
cÚ‹xt
.
”r
 = 0;

490 
i
 = 0; i < 
wb
->
Ä_£gm’ts
; i++) {

491 
dm_io_»que¡
 
io_»q_£g
 = {

492 
WB_IO_WRITE
,

493 .
ş›Á
 = 
wb
->
io_ş›Á
,

494 .
nÙify
.
â
 = 
fÜm©_£gmd_’dio
,

495 .
nÙify
.
cÚ‹xt
 = &context,

496 .
mem
.
ty³
 = 
DM_IO_KMEM
,

497 .
mem
.
±r
.
addr
 = 
buf
,

499 
dm_io_»giÚ
 
»giÚ_£g
 = {

500 .
bdev
 = 
dev
->bdev,

501 .
£ùÜ
 = 
	`ÿlc_£gm’t_h—d”_¡¬t
(
wb
, 
i
),

502 .
couÁ
 = (1 << 3),

504 
”r
 = 
	`wb_io
(&
io_»q_£g
, 1, &
»giÚ_£g
, 
NULL
, 
çl£
);

505 ià(
”r
)

509 ià(
”r
)

510 
bad
;

513 
	`©omic64_»ad
(&
cÚ‹xt
.
couÁ
))

514 
	`scheduË_timeout_š‹¼u±ibË
(
	`m£cs_to_jiff›s
(100));

516 ià(
cÚ‹xt
.
”r
) {

517 
	`DMERR
("I/O failed");

518 
”r
 = -
EIO
;

519 
bad
;

522 
”r
 = 
	`blkdev_issue_æush
(
dev
->
bdev
, 
GFP_KERNEL
, 
NULL
);

524 
bad
:

525 
	`mempoŞ_ä“
(
buf
, 
wb
->
buf_8_poŞ
);

526  
”r
;

527 
	}
}

532 
	$fÜm©_ÿche_deviû
(
wb_deviû
 *
wb
)

534 
”r
 = 
	`z”ošg_fuÎ_su³rblock
(
wb
);

535 ià(
”r
) {

536 
	`DMERR
("zeroing_full_superblock failed");

537  
”r
;

539 
”r
 = 
	`fÜm©_®l_£gm’t_h—d”s
(
wb
);

540 ià(
”r
) {

541 
	`DMERR
("format_all_segment_headers failed");

542  
”r
;

544 
”r
 = 
	`fÜm©_su³rblock_h—d”
(
wb
);

545 ià(
”r
) {

546 
	`DMERR
("format_superblock_header failed");

547  
”r
;

549  
”r
;

550 
	}
}

558 
	$might_fÜm©_ÿche_deviû
(
wb_deviû
 *
wb
)

560 
”r
 = 0;

562 
”r
 = 
	`aud™_ÿche_deviû
(
wb
);

563 ià(
”r
) {

564 
	`DMERR
("audit_cache_device failed");

565  
”r
;

568 ià(
wb
->
do_fÜm©
) {

569 
”r
 = 
	`fÜm©_ÿche_deviû
(
wb
);

570 ià(
”r
) {

571 
	`DMERR
("format_cache_device failed");

572  
”r
;

576  
”r
;

577 
	}
}

581 
	$š™_¿mbuf_poŞ
(
wb_deviû
 *
wb
)

583 
”r
 = 0;

584 
size_t
 
i
;

586 
wb
->
¿mbuf_poŞ
 = 
	`km®loc
((
¿mbufãr
è* 
NR_RAMBUF_POOL
, 
GFP_KERNEL
);

587 ià(!
wb
->
¿mbuf_poŞ
)

588  -
ENOMEM
;

590 
i
 = 0; i < 
NR_RAMBUF_POOL
; i++) {

591 *
®loûd
 = 
	`vm®loc
(1 << (
SEGMENT_SIZE_ORDER
 + 9));

592 ià(!
®loûd
) {

593 
size_t
 
j
;

594 
	`DMERR
("Failedo‡llocate„ambuf->data");

595 
j
 = 0; j < 
i
; j++) {

596 
	`vä“
(
wb
->
¿mbuf_poŞ
[
j
].
d©a
);

598 
”r
 = -
ENOMEM
;

599 
bad_®loc_d©a
;

601 
wb
->
¿mbuf_poŞ
[
i
].
d©a
 = 
®loûd
;

604  
”r
;

606 
bad_®loc_d©a
:

607 
	`kä“
(
wb
->
¿mbuf_poŞ
);

608  
”r
;

609 
	}
}

611 
	$ä“_¿mbuf_poŞ
(
wb_deviû
 *
wb
)

613 
size_t
 
i
;

614 
i
 = 0; i < 
NR_RAMBUF_POOL
; i++)

615 
	`vä“
(
wb
->
¿mbuf_poŞ
[
i
].
d©a
);

616 
	`kä“
(
wb
->
¿mbuf_poŞ
);

617 
	}
}

619 
¿mbufãr
 *
	$g‘_¿mbufãr_by_id
(
wb_deviû
 *
wb
, 
u64
 
id
)

621 
u32
 
tmp32
;

622 
	`div_u64_»m
(
id
 - 1, 
NR_RAMBUF_POOL
, &
tmp32
);

623  
wb
->
¿mbuf_poŞ
 + 
tmp32
;

624 
	}
}

633 
	$š™_deviûs
(
wb_deviû
 *
wb
)

635 
”r
 = 0;

637 
”r
 = 
	`might_fÜm©_ÿche_deviû
(
wb
);

638 ià(
”r
)

639  
”r
;

641 
”r
 = 
	`š™_¿mbuf_poŞ
(
wb
);

642 ià(
”r
) {

643 
	`DMERR
("init_rambuf_pool failed");

644  
”r
;

647  
”r
;

648 
	}
}

650 
	$ä“_deviûs
(
wb_deviû
 *
wb
)

652 
	`ä“_¿mbuf_poŞ
(
wb
);

653 
	}
}

657 
	$»ad_su³rblock_»cÜd
(
su³rblock_»cÜd_deviû
 *
»cÜd
,

658 
wb_deviû
 *
wb
)

660 
”r
 = 0;

661 
dm_io_»que¡
 
io_»q
;

662 
dm_io_»giÚ
 
»giÚ
;

664 *
buf
 = 
	`mempoŞ_®loc
(
wb
->
buf_8_poŞ
, 
GFP_KERNEL
);

665 ià(!
buf
)

666  -
ENOMEM
;

668 
	`check_bufãr_®ignm’t
(
buf
);

670 
io_»q
 = (
dm_io_»que¡
) {

671 
WB_IO_READ
,

672 .
ş›Á
 = 
wb
->
io_ş›Á
,

673 .
nÙify
.
â
 = 
NULL
,

674 .
mem
.
ty³
 = 
DM_IO_KMEM
,

675 .
mem
.
±r
.
addr
 = 
buf
,

677 
»giÚ
 = (
dm_io_»giÚ
) {

678 .
bdev
 = 
wb
->
ÿche_dev
->bdev,

679 .
£ùÜ
 = (1 << 11) - 8,

680 .
couÁ
 = 8,

682 
”r
 = 
	`wb_io
(&
io_»q
, 1, &
»giÚ
, 
NULL
, 
çl£
);

683 ià(
”r
)

684 
bad_io
;

686 
	`memıy
(
»cÜd
, 
buf
 + (7 << 9), (*record));

688 
bad_io
:

689 
	`mempoŞ_ä“
(
buf
, 
wb
->
buf_8_poŞ
);

690  
”r
;

691 
	}
}

696 
	$»ad_whŞe_£gm’t
(*
buf
, 
wb_deviû
 *
wb
,

697 
£gm’t_h—d”
 *
£g
)

699 
dm_io_»que¡
 
io_»q
 = {

700 
WB_IO_READ
,

701 .
ş›Á
 = 
wb
->
io_ş›Á
,

702 .
nÙify
.
â
 = 
NULL
,

703 .
mem
.
ty³
 = 
DM_IO_VMA
,

704 .
mem
.
±r
.
addr
 = 
buf
,

706 
dm_io_»giÚ
 
»giÚ
 = {

707 .
bdev
 = 
wb
->
ÿche_dev
->bdev,

708 .
£ùÜ
 = 
£g
->
¡¬t_£ùÜ
,

709 .
couÁ
 = 1 << 
SEGMENT_SIZE_ORDER
,

711  
	`wb_io
(&
io_»q
, 1, &
»giÚ
, 
NULL
, 
çl£
);

712 
	}
}

718 
u32
 
	$ÿlc_checksum
(*
¿mbufãr
, 
u8
 
Ëngth
)

720 
Ën
 = (4096 - 512è+ 4096 * 
Ëngth
;

721  ~
	`üc32c
(0xffffffff, 
¿mbufãr
 + 512, 
Ën
);

722 
	}
}

724 
	$´•¬e_£gm’t_h—d”_deviû
(*
¿mbufãr
,

725 
wb_deviû
 *
wb
,

726 
£gm’t_h—d”
 *
¤c
)

728 
£gm’t_h—d”_deviû
 *
de¡
 = 
¿mbufãr
;

729 
u32
 
i
;

731 
	`ASSERT
((
¤c
->
Ëngth
è=ğ(
wb
->
cursÜ
 - src->
¡¬t_idx
));

733 
i
 = 0; i < 
¤c
->
Ëngth
; i++) {

734 
m‘ablock
 *
mb
 = 
¤c
->
mb_¬¿y
 + 
i
;

735 
m‘ablock_deviû
 *
mbdev
 = 
de¡
->
mb¬r
 + 
i
;

737 
mbdev
->
£ùÜ
 = 
	`ıu_to_Ë64
((
u64
)
mb
->sector);

738 
mbdev
->
dœty_b™s
 = 
mb
->
dœtšess
.
is_dœty
 ? mb->dœtšess.
d©a_b™s
 : 0;

741 
de¡
->
id
 = 
	`ıu_to_Ë64
(
¤c
->id);

742 
de¡
->
Ëngth
 = 
¤c
->length;

743 
de¡
->
checksum
 = 
	`ıu_to_Ë32
(
	`ÿlc_checksum
(
¿mbufãr
, 
¤c
->
Ëngth
));

744 
	}
}

751 
	$­¶y_m‘ablock_deviû
(
wb_deviû
 *
wb
, 
£gm’t_h—d”
 *
£g
,

752 
£gm’t_h—d”_deviû
 *
¤c
, 
u8
 
i
)

754 
lookup_key
 
key
;

755 
ht_h—d
 *
h—d
;

756 
m‘ablock
 *
found
 = 
NULL
, *
mb
 = 
£g
->
mb_¬¿y
 + 
i
;

757 
m‘ablock_deviû
 *
mbdev
 = 
¤c
->
mb¬r
 + 
i
;

759 
mb
->
£ùÜ
 = 
	`Ë64_to_ıu
(
mbdev
->sector);

761 
mb
->
dœtšess
.
d©a_b™s
 = 
mbdev
->
dœty_b™s
 ? mbdev->dirty_bits : 255;

762 
mb
->
dœtšess
.
is_dœty
 = 
mbdev
->
dœty_b™s
 ? 
Œue
 : 
çl£
;

764 
key
 = (
lookup_key
) {

765 .
£ùÜ
 = 
mb
->sector,

767 
h—d
 = 
	`ht_g‘_h—d
(
wb
, &
key
);

768 
found
 = 
	`ht_lookup
(
wb
, 
h—d
, &
key
);

769 ià(
found
) {

770 
”r
 = 0;

771 
u8
 
i
;

772 
wr™e_io
 
wio
;

773 *
buf
 = 
	`mempoŞ_®loc
(
wb
->
buf_8_poŞ
, 
GFP_KERNEL
);

774 ià(!
buf
)

775  -
ENOMEM
;

777 
wio
 = (
wr™e_io
) {

778 .
d©a
 = 
buf
,

779 .
d©a_b™s
 = 0,

781 
”r
 = 
	`´•¬e_ov”wr™e
(
wb
, 
	`mb_to_£g
(wb, 
found
), found, &
wio
, 
mb
->
dœtšess
.
d©a_b™s
);

782 ià(
”r
)

783 
ç_out
;

785 
i
 = 0; i < 8; i++) {

786 
dm_io_»que¡
 
io_»q
;

787 
dm_io_»giÚ
 
»giÚ
;

788 ià(!(
wio
.
d©a_b™s
 & (1 << 
i
)))

791 
io_»q
 = (
dm_io_»que¡
) {

792 
WB_IO_WRITE
,

793 .
ş›Á
 = 
wb
->
io_ş›Á
,

794 .
nÙify
.
â
 = 
NULL
,

795 .
mem
.
ty³
 = 
DM_IO_KMEM
,

796 .
mem
.
±r
.
addr
 = 
wio
.
d©a
 + (
i
 << 9),

798 
»giÚ
 = (
dm_io_»giÚ
) {

799 .
bdev
 = 
wb
->
backšg_dev
->bdev,

800 .
£ùÜ
 = 
mb
->£ùÜ + 
i
,

801 .
couÁ
 = 1,

803 
”r
 = 
	`wb_io
(&
io_»q
, 1, &
»giÚ
, 
NULL
, 
Œue
);

804 ià(
”r
)

808 
ç_out
:

809 
	`mempoŞ_ä“
(
buf
, 
wb
->
buf_8_poŞ
);

810 ià(
”r
)

811  
”r
;

814 
	`ht_»gi¡”
(
wb
, 
h—d
, 
mb
, &
key
);

816 ià(
mb
->
dœtšess
.
is_dœty
)

817 
	`šc_Ä_dœty_ÿches
(
wb
);

820 
	}
}

822 
	$­¶y_£gm’t_h—d”_deviû
(
wb_deviû
 *
wb
, 
£gm’t_h—d”
 *
£g
,

823 
£gm’t_h—d”_deviû
 *
¤c
)

825 
”r
 = 0;

826 
u8
 
i
;

827 
£g
->
Ëngth
 = 
¤c
->length;

828 
i
 = 0; i < 
¤c
->
Ëngth
; i++) {

829 
”r
 = 
	`­¶y_m‘ablock_deviû
(
wb
, 
£g
, 
¤c
, 
i
);

830 ià(
”r
)

833  
”r
;

834 
	}
}

839 
	$»ad_£gm’t_h—d”
(*
buf
, 
wb_deviû
 *
wb
,

840 
£gm’t_h—d”
 *
£g
)

842 
dm_io_»que¡
 
io_»q
 = {

843 
WB_IO_READ
,

844 .
ş›Á
 = 
wb
->
io_ş›Á
,

845 .
nÙify
.
â
 = 
NULL
,

846 .
mem
.
ty³
 = 
DM_IO_KMEM
,

847 .
mem
.
±r
.
addr
 = 
buf
,

849 
dm_io_»giÚ
 
»giÚ
 = {

850 .
bdev
 = 
wb
->
ÿche_dev
->bdev,

851 .
£ùÜ
 = 
£g
->
¡¬t_£ùÜ
,

852 .
couÁ
 = 8,

854  
	`wb_io
(&
io_»q
, 1, &
»giÚ
, 
NULL
, 
çl£
);

855 
	}
}

861 
	$do_fšd_max_id
(
wb_deviû
 *
wb
, 
u64
 *
max_id
)

863 
”r
 = 0;

864 
u32
 
k
;

866 *
buf
 = 
	`mempoŞ_®loc
(
wb
->
buf_8_poŞ
, 
GFP_KERNEL
);

867 ià(!
buf
)

868  -
ENOMEM
;

869 
	`check_bufãr_®ignm’t
(
buf
);

871 *
max_id
 = 0;

872 
k
 = 0; k < 
wb
->
Ä_£gm’ts
; k++) {

873 
£gm’t_h—d”
 *
£g
 = 
	`£gm’t_©
(
wb
, 
k
);

874 
£gm’t_h—d”_deviû
 *
h—d”
;

875 
”r
 = 
	`»ad_£gm’t_h—d”
(
buf
, 
wb
, 
£g
);

876 ià(
”r
)

877 
out
;

879 
h—d”
 = 
buf
;

880 ià(
	`Ë64_to_ıu
(
h—d”
->
id
è> *
max_id
)

881 *
max_id
 = 
	`Ë64_to_ıu
(
h—d”
->
id
);

883 
out
:

884 
	`mempoŞ_ä“
(
buf
, 
wb
->
buf_8_poŞ
);

885  
”r
;

886 
	}
}

888 
	$fšd_max_id
(
wb_deviû
 *
wb
, 
u64
 *
max_id
)

895 ià(
wb
->
do_fÜm©
) {

896 *
max_id
 = 0;

900  
	`do_fšd_max_id
(
wb
, 
max_id
);

901 
	}
}

913 
	$do_­¶y_v®id_£gm’ts
(
wb_deviû
 *
wb
, 
u64
 *
max_id
)

915 
”r
 = 0;

916 
£gm’t_h—d”
 *
£g
;

917 
£gm’t_h—d”_deviû
 *
h—d”
;

918 
u32
 
i
, 
¡¬t_idx
;

920 *
¿mbuf
 = 
	`vm®loc
(1 << (
SEGMENT_SIZE_ORDER
 + 9));

921 ià(!
¿mbuf
)

922  -
ENOMEM
;

928 
¡¬t_idx
 = 
	`£gm’t_id_to_idx
(
wb
, *
max_id
 + 1);

929 *
max_id
 = 0;

931 
i
 = 
¡¬t_idx
; i < (¡¬t_idx + 
wb
->
Ä_£gm’ts
); i++) {

932 
u32
 
aùu®
, 
ex³ùed
, 
k
;

933 
	`div_u64_»m
(
i
, 
wb
->
Ä_£gm’ts
, &
k
);

934 
£g
 = 
	`£gm’t_©
(
wb
, 
k
);

936 
”r
 = 
	`»ad_whŞe_£gm’t
(
¿mbuf
, 
wb
, 
£g
);

937 ià(
”r
)

940 
h—d”
 = 
¿mbuf
;

948 ià(!
	`Ë64_to_ıu
(
h—d”
->
id
))

955 
aùu®
 = 
	`ÿlc_checksum
(
¿mbuf
, 
h—d”
->
Ëngth
);

956 
ex³ùed
 = 
	`Ë32_to_ıu
(
h—d”
->
checksum
);

957 ià(
aùu®
 !ğ
ex³ùed
) {

958 
	`DMWARN
("Checksum incorrect id:%llu checksum: %u != %u",

959 (è
	`Ë64_to_ıu
(
h—d”
->
id
),

960 
aùu®
, 
ex³ùed
);

965 
”r
 = 
	`­¶y_£gm’t_h—d”_deviû
(
wb
, 
£g
, 
h—d”
);

966 ià(
”r
)

969 *
max_id
 = 
	`Ë64_to_ıu
(
h—d”
->
id
);

972 
	`vä“
(
¿mbuf
);

973  
”r
;

974 
	}
}

976 
	$­¶y_v®id_£gm’ts
(
wb_deviû
 *
wb
, 
u64
 *
max_id
)

983 ià(!(*
max_id
))

986  
	`do_­¶y_v®id_£gm’ts
(
wb
, 
max_id
);

987 
	}
}

989 
	$šãr_Ï¡_wr™eback_id
(
wb_deviû
 *
wb
)

991 
”r
 = 0;

993 
u64
 
šã¼ed_Ï¡_wr™eback_id
;

994 
u64
 
»cÜd_id
;

996 
su³rblock_»cÜd_deviû
 
	`unš™Ÿlized_v¬
(
»cÜd
);

997 
”r
 = 
	`»ad_su³rblock_»cÜd
(&
»cÜd
, 
wb
);

998 ià(
”r
)

999  
”r
;

1001 
šã¼ed_Ï¡_wr™eback_id
 =

1002 
	`SUB_ID
(
	`©omic64_»ad
(&
wb
->
Ï¡_æushed_£gm’t_id
), wb->
Ä_£gm’ts
);

1009 
»cÜd_id
 = 
	`Ë64_to_ıu
(
»cÜd
.
Ï¡_wr™eback_£gm’t_id
);

1010 ià(
»cÜd_id
 > 
šã¼ed_Ï¡_wr™eback_id
) {

1011 
u64
 
id
;

1012 
id
 = 
šã¼ed_Ï¡_wr™eback_id
 + 1; id <ğ
»cÜd_id
; id++)

1013 
	`m¬k_ş—n_£g
(
wb
, 
	`g‘_£gm’t_h—d”_by_id
(wb, 
id
));

1014 
šã¼ed_Ï¡_wr™eback_id
 = 
»cÜd_id
;

1017 
	`©omic64_£t
(&
wb
->
Ï¡_wr™eback_£gm’t_id
, 
šã¼ed_Ï¡_wr™eback_id
);

1018  
”r
;

1019 
	}
}

1033 
	$»¶ay_log_Ú_ÿche
(
wb_deviû
 *
wb
)

1035 
”r
 = 0;

1037 
u64
 
max_id
;

1038 
”r
 = 
	`fšd_max_id
(
wb
, &
max_id
);

1039 ià(
”r
) {

1040 
	`DMERR
("find_max_id failed");

1041  
”r
;

1044 
”r
 = 
	`­¶y_v®id_£gm’ts
(
wb
, &
max_id
);

1045 ià(
”r
) {

1046 
	`DMERR
("apply_valid_segments failed");

1047  
”r
;

1051 
	`©omic64_£t
(&
wb
->
Ï¡_æushed_£gm’t_id
, 
max_id
);

1054 
	`©omic64_£t
(&
wb
->
Ï¡_queued_£gm’t_id
, 
max_id
);

1057 
	`šãr_Ï¡_wr™eback_id
(
wb
);

1059  
”r
;

1060 
	}
}

1065 
	$´•¬e_fœ¡_£g
(
wb_deviû
 *
wb
)

1067 
u64
 
š™_£gm’t_id
 = 
	`©omic64_»ad
(&
wb
->
Ï¡_æushed_£gm’t_id
) + 1;

1068 
	`acquœe_Ãw_£g
(
wb
, 
š™_£gm’t_id
);

1069 
	`cursÜ_š™
(
wb
);

1070 
	}
}

1075 
	$»cov”_ÿche
(
wb_deviû
 *
wb
)

1077 
”r
 = 0;

1079 
”r
 = 
	`»¶ay_log_Ú_ÿche
(
wb
);

1080 ià(
”r
) {

1081 
	`DMERR
("replay_log_on_cache failed");

1082  
”r
;

1085 
	`´•¬e_fœ¡_£g
(
wb
);

1087 
	}
}

1091 
wr™eback_£gm’t
 *
	$®loc_wr™eback_£gm’t
(
wb_deviû
 *
wb
, 
gå_t
 
gå
)

1093 
u8
 
i
;

1095 
wr™eback_£gm’t
 *
wr™eback_£g
 = 
	`km®loc
((*wr™eback_£g), 
gå
);

1096 ià(!
wr™eback_£g
)

1097 
bad_wr™eback_£g
;

1099 
wr™eback_£g
->
ios
 = 
	`km®loc
(
wb
->
Ä_ÿches_š£g
 * (
wr™eback_io
), 
gå
);

1100 ià(!
wr™eback_£g
->
ios
)

1101 
bad_ios
;

1103 
wr™eback_£g
->
buf
 = 
	`vm®loc
((1 << (
SEGMENT_SIZE_ORDER
 + 9)) - (1 << 12));

1104 ià(!
wr™eback_£g
->
buf
)

1105 
bad_buf
;

1107 
i
 = 0; i < 
wb
->
Ä_ÿches_š£g
; i++) {

1108 
wr™eback_io
 *wr™eback_iØğ
wr™eback_£g
->
ios
 + 
i
;

1109 
wr™eback_io
->
d©a
 = 
wr™eback_£g
->
buf
 + (
i
 << 12);

1110 
	`´štk
("®loc_wr™eback_£gm’t(èd©a: %Îu, io_d©a: %Îu\n",
wr™eback_£g
->
buf
,
wr™eback_io
->
d©a
);

1113  
wr™eback_£g
;

1115 
bad_buf
:

1116 
	`kä“
(
wr™eback_£g
->
ios
);

1117 
bad_ios
:

1118 
	`kä“
(
wr™eback_£g
);

1119 
bad_wr™eback_£g
:

1120  
NULL
;

1121 
	}
}

1123 
	$ä“_wr™eback_£gm’t
(
wb_deviû
 *
wb
, 
wr™eback_£gm’t
 *
wr™eback_£g
)

1125 
	`vä“
(
wr™eback_£g
->
buf
);

1126 
	`kä“
(
wr™eback_£g
->
ios
);

1127 
	`kä“
(
wr™eback_£g
);

1128 
	}
}

1137 
	$ä“_wr™eback_ios
(
wb_deviû
 *
wb
)

1139 
size_t
 
i
;

1140 
i
 = 0; i < 
wb
->
Ä_cur_b©ched_wr™eback
; i++)

1141 
	`ä“_wr™eback_£gm’t
(
wb
, *(wb->
wr™eback_£gs
 + 
i
));

1142 
	`kä“
(
wb
->
wr™eback_£gs
);

1143 
	}
}

1149 
	$Œy_®loc_wr™eback_ios
(
wb_deviû
 *
wb
, 
size_t
 
Ä_b©ch
, 
gå_t
 
gå
)

1151 
”r
 = 0;

1152 
size_t
 
i
;

1154 
wr™eback_£gm’t
 **
wr™eback_£gs
 = 
	`kz®loc
(

1155 
Ä_b©ch
 * (
wr™eback_£gm’t
 *), 
gå
);

1156 ià(!
wr™eback_£gs
)

1157  -
ENOMEM
;

1159 
i
 = 0; i < 
Ä_b©ch
; i++) {

1160 
wr™eback_£gm’t
 *
®loûd
 = 
	`®loc_wr™eback_£gm’t
(
wb
, 
gå
);

1161 ià(!
®loûd
) {

1162 
size_t
 
j
;

1163 
j
 = 0; j < 
i
; j++)

1164 
	`ä“_wr™eback_£gm’t
(
wb
, 
wr™eback_£gs
[
j
]);

1165 
	`kä“
(
wr™eback_£gs
);

1167 
	`DMERR
("Failedo‡llocate writeback_segs");

1168  -
ENOMEM
;

1170 
wr™eback_£gs
[
i
] = 
®loûd
;

1177 ià(
wb
->
wr™eback_£gs
)

1178 
	`ä“_wr™eback_ios
(
wb
);

1181 
wb
->
wr™eback_£gs
 = writeback_segs;

1182 
wb
->
Ä_wr™eback_£gs
 = 
Ä_b©ch
;

1184  
”r
;

1185 
	}
}

1189 
	#CREATE_DAEMON
(
Çme
) \

1191 
wb
->
Çme
 = 
	`kth»ad_ü—‹
( \

1192 
Çme
##
_´oc
, 
wb
, "dmwb_" #name); \

1193 ià(
	`IS_ERR
(
wb
->
Çme
)) { \

1194 
”r
 = 
	`PTR_ERR
(
wb
->
Çme
); \

1195 
wb
->
Çme
 = 
NULL
; \

1196 
	`DMERR
("couldn't spawn " #name); \

1197 
bad_
##
Çme
; \

1199 
	`wake_up_´oûss
(
wb
->
Çme
); \

1200 } 0)

	)

1210 
	$š™_m‘ad©a
(
wb_deviû
 *
wb
)

1212 
”r
 = 0;

1214 
”r
 = 
	`š™_£gm’t_h—d”_¬¿y
(
wb
);

1215 ià(
”r
) {

1216 
	`DMERR
("init_segment_header_array failed");

1217 
bad_®loc_£gm’t_h—d”_¬¿y
;

1220 
”r
 = 
	`ht_em±y_š™
(
wb
);

1221 ià(
”r
) {

1222 
	`DMERR
("ht_empty_init failed");

1223 
bad_®loc_ht
;

1226  
”r
;

1228 
bad_®loc_ht
:

1229 
	`ä“_£gm’t_h—d”_¬¿y
(
wb
);

1230 
bad_®loc_£gm’t_h—d”_¬¿y
:

1231  
”r
;

1232 
	}
}

1234 
	$ä“_m‘ad©a
(
wb_deviû
 *
wb
)

1236 
	`ä“_ht
(
wb
);

1237 
	`ä“_£gm’t_h—d”_¬¿y
(
wb
);

1238 
	}
}

1240 
	$š™_wr™eback_d«mÚ
(
wb_deviû
 *
wb
)

1242 
”r
 = 0;

1243 
size_t
 
Ä_b©ch
;

1245 
	`©omic_£t
(&
wb
->
wr™eback_ç_couÁ
, 0);

1246 
	`©omic_£t
(&
wb
->
wr™eback_io_couÁ
, 0);

1250 
Ä_b©ch
 = 4096;

1253 
wb
->
Ä_max_b©ched_wr™eback
 = 
Ä_b©ch
;

1254 ià(
	`Œy_®loc_wr™eback_ios
(
wb
, 
Ä_b©ch
, 
GFP_KERNEL
))

1255  -
ENOMEM
;

1257 
	`š™_wa™queue_h—d
(&
wb
->
wr™eback_wa™_queue
);

1258 
	`š™_wa™queue_h—d
(&
wb
->
wa™_drİ_ÿches
);

1259 
	`š™_wa™queue_h—d
(&
wb
->
wr™eback_io_wa™_queue
);

1261 
wb
->
®low_wr™eback
 = 
çl£
;

1262 
wb
->
urge_wr™eback
 = 
çl£
;

1263 
wb
->
fÜû_drİ
 = 
çl£
;

1264 
	`CREATE_DAEMON
(
wr™eback_d«mÚ
);

1266  
”r
;

1268 
bad_wr™eback_d«mÚ
:

1269 
	`ä“_wr™eback_ios
(
wb
);

1270  
”r
;

1271 
	}
}

1273 
	$š™_æush_d«mÚ
(
wb_deviû
 *
wb
)

1275 
”r
 = 0;

1276 
	`š™_wa™queue_h—d
(&
wb
->
æush_wa™_queue
);

1277 
	`CREATE_DAEMON
(
æush_d«mÚ
);

1278  
”r
;

1280 
bad_æush_d«mÚ
:

1281  
”r
;

1282 
	}
}

1284 
	$š™_æush_b¬r›r_wÜk
(
wb_deviû
 *
wb
)

1286 
wb
->
b¬r›r_wq
 = 
	`ü—‹_sšgËth»ad_wÜkqueue
("dmwb_barrier");

1287 ià(!
wb
->
b¬r›r_wq
) {

1288 
	`DMERR
("Failedo‡llocate barrier_wq");

1289  -
ENOMEM
;

1291 
	`bio_li¡_š™
(&
wb
->
b¬r›r_ios
);

1292 
	`INIT_WORK
(&
wb
->
æush_b¬r›r_wÜk
, 
æush_b¬r›r_ios
);

1294 
	}
}

1296 
	$š™_wr™eback_moduÏtÜ
(
wb_deviû
 *
wb
)

1298 
”r
 = 0;

1299 
wb
->
wr™eback_th»shŞd
 = 0;

1300 
	`CREATE_DAEMON
(
wr™eback_moduÏtÜ
);

1301  
”r
;

1303 
bad_wr™eback_moduÏtÜ
:

1304  
”r
;

1305 
	}
}

1307 
	$š™_sb_»cÜd_upd©”
(
wb_deviû
 *
wb
)

1309 
”r
 = 0;

1310 
wb
->
upd©e_sb_»cÜd_š‹rv®
 = 0;

1311 
	`CREATE_DAEMON
(
sb_»cÜd_upd©”
);

1312  
”r
;

1314 
bad_sb_»cÜd_upd©”
:

1315  
”r
;

1316 
	}
}

1318 
	$š™_d©a_synchrÚiz”
(
wb_deviû
 *
wb
)

1320 
”r
 = 0;

1321 
wb
->
sync_d©a_š‹rv®
 = 0;

1322 
	`CREATE_DAEMON
(
d©a_synchrÚiz”
);

1323  
”r
;

1325 
bad_d©a_synchrÚiz”
:

1326  
”r
;

1327 
	}
}

1329 
	$»sume_ÿche
(
wb_deviû
 *
wb
)

1331 
”r
 = 0;

1333 
wb
->
Ä_£gm’ts
 = 
	`ÿlc_Ä_£gm’ts
(wb->
ÿche_dev
, wb);

1334 
wb
->
Ä_ÿches_š£g
 = (1 << (
SEGMENT_SIZE_ORDER
 - 3)) - 1;

1335 
wb
->
Ä_ÿches
 = wb->
Ä_£gm’ts
 * wb->
Ä_ÿches_š£g
;

1337 
”r
 = 
	`š™_deviûs
(
wb
);

1338 ià(
”r
)

1339 
bad_deviûs
;

1341 
”r
 = 
	`š™_m‘ad©a
(
wb
);

1342 ià(
”r
)

1343 
bad_m‘ad©a
;

1345 
”r
 = 
	`š™_wr™eback_d«mÚ
(
wb
);

1346 ià(
”r
) {

1347 
	`DMERR
("init_writeback_daemon failed");

1348 
bad_wr™eback_d«mÚ
;

1351 
”r
 = 
	`»cov”_ÿche
(
wb
);

1352 ià(
”r
) {

1353 
	`DMERR
("recover_cache failed");

1354 
bad_»cov”
;

1357 
”r
 = 
	`š™_æush_d«mÚ
(
wb
);

1358 ià(
”r
) {

1359 
	`DMERR
("init_flush_daemon failed");

1360 
bad_æush_d«mÚ
;

1363 
”r
 = 
	`š™_æush_b¬r›r_wÜk
(
wb
);

1364 ià(
”r
) {

1365 
	`DMERR
("init_flush_barrier_work failed");

1366 
bad_æush_b¬r›r_wÜk
;

1369 
”r
 = 
	`š™_wr™eback_moduÏtÜ
(
wb
);

1370 ià(
”r
) {

1371 
	`DMERR
("init_writeback_modulator failed");

1372 
bad_moduÏtÜ
;

1375 
”r
 = 
	`š™_sb_»cÜd_upd©”
(
wb
);

1376 ià(
”r
) {

1377 
	`DMERR
("init_sb_recorder failed");

1378 
bad_upd©”
;

1381 
”r
 = 
	`š™_d©a_synchrÚiz”
(
wb
);

1382 ià(
”r
) {

1383 
	`DMERR
("init_data_synchronizer failed");

1384 
bad_synchrÚiz”
;

1387  
”r
;

1389 
bad_synchrÚiz”
:

1390 
	`kth»ad_¡İ
(
wb
->
sb_»cÜd_upd©”
);

1391 
bad_upd©”
:

1392 
	`kth»ad_¡İ
(
wb
->
wr™eback_moduÏtÜ
);

1393 
bad_moduÏtÜ
:

1394 
	`de¡roy_wÜkqueue
(
wb
->
b¬r›r_wq
);

1395 
bad_æush_b¬r›r_wÜk
:

1396 
	`kth»ad_¡İ
(
wb
->
æush_d«mÚ
);

1397 
bad_æush_d«mÚ
:

1398 
bad_»cov”
:

1399 
	`kth»ad_¡İ
(
wb
->
wr™eback_d«mÚ
);

1400 
	`ä“_wr™eback_ios
(
wb
);

1401 
bad_wr™eback_d«mÚ
:

1402 
	`ä“_m‘ad©a
(
wb
);

1403 
bad_m‘ad©a
:

1404 
	`ä“_deviûs
(
wb
);

1405 
bad_deviûs
:

1406  
”r
;

1407 
	}
}

1409 
	$ä“_ÿche
(
wb_deviû
 *
wb
)

1415 
	`kth»ad_¡İ
(
wb
->
d©a_synchrÚiz”
);

1416 
	`kth»ad_¡İ
(
wb
->
sb_»cÜd_upd©”
);

1417 
	`kth»ad_¡İ
(
wb
->
wr™eback_moduÏtÜ
);

1419 
	`de¡roy_wÜkqueue
(
wb
->
b¬r›r_wq
);

1421 
	`kth»ad_¡İ
(
wb
->
æush_d«mÚ
);

1423 
	`kth»ad_¡İ
(
wb
->
wr™eback_d«mÚ
);

1424 
	`ä“_wr™eback_ios
(
wb
);

1426 
	`ä“_m‘ad©a
(
wb
);

1428 
	`ä“_deviûs
(
wb
);

1429 
	}
}

	@dm-writeboost-metadata.h

20 #iâdeà
DM_WRITEBOOST_METADATA_H


21 
	#DM_WRITEBOOST_METADATA_H


	)

25 
£gm’t_h—d”
 *

26 
g‘_£gm’t_h—d”_by_id
(
wb_deviû
 *, 
u64
 
£gm’t_id
);

27 
¿mbufãr
 *
g‘_¿mbufãr_by_id
(
wb_deviû
 *
wb
, 
u64
 
id
);

28 
£ùÜ_t
 
ÿlc_mb_¡¬t_£ùÜ
(
wb_deviû
 *, 
£gm’t_h—d”
 *,

29 
u32
 
mb_idx
);

30 
u8
 
mb_idx_š£g
(
wb_deviû
 *, 
u32
 
mb_idx
);

31 
£gm’t_h—d”
 *
mb_to_£g
(
wb_deviû
 *, 
m‘ablock
 *);

32 
boŞ
 
is_Ú_bufãr
(
wb_deviû
 *, 
u32
 
mb_idx
);

36 
	slookup_key
 {

37 
£ùÜ_t
 
	m£ùÜ
;

40 
	ght_h—d
;

41 
ht_h—d
 *
ht_g‘_h—d
(
wb_deviû
 *, 
lookup_key
 *);

42 
m‘ablock
 *
ht_lookup
(
wb_deviû
 *,

43 
ht_h—d
 *, 
lookup_key
 *);

44 
ht_»gi¡”
(
wb_deviû
 *, 
ht_h—d
 *,

45 
m‘ablock
 *, 
lookup_key
 *);

46 
ht_d–
(
wb_deviû
 *, 
m‘ablock
 *);

47 
disÿrd_ÿches_š£g
(
wb_deviû
 *, 
£gm’t_h—d”
 *);

51 
´•¬e_£gm’t_h—d”_deviû
(*
¿mbufãr
, 
wb_deviû
 *,

52 
£gm’t_h—d”
 *
¤c
);

53 
u32
 
ÿlc_checksum
(*
¿mbufãr
, 
u8
 
Ëngth
);

57 
Œy_®loc_wr™eback_ios
(
wb_deviû
 *, 
size_t
 
Ä_b©ch
, 
gå_t
 
gå
);

61 
»sume_ÿche
(
wb_deviû
 *);

62 
ä“_ÿche
(
wb_deviû
 *);

	@dm-writeboost-target.c

23 
	~"dm-wr™eboo¡.h
"

24 
	~"dm-wr™eboo¡-m‘ad©a.h
"

25 
	~"dm-wr™eboo¡-d«mÚ.h
"

27 
	~"lšux/sÜt.h
"

31 
	$do_check_bufãr_®ignm’t
(*
buf
, cÚ¡ *
Çme
, cÚ¡ *
ÿÎ”
)

33 
addr
 = (è
buf
;

35 ià(!
	`IS_ALIGNED
(
addr
, 1 << 9)) {

36 
	`DMCRIT
("@% š % i nÙ seùÜ-®igÃd. I/O bufã¸mu¡ b£ùÜ-®igÃd.", 
Çme
, 
ÿÎ”
);

37 
	`BUG
();

39 
	}
}

43 
	swb_io
 {

44 
wÜk_¡ruù
 
	mwÜk
;

45 
	m”r
;

46 
	m”r_b™s
;

47 
dm_io_»que¡
 *
	mio_»q
;

48 
	mnum_»giÚs
;

49 
dm_io_»giÚ
 *
	m»giÚs
;

52 
	$wb_io_â
(
wÜk_¡ruù
 *
wÜk
)

54 
wb_io
 *
io
 = 
	`cÚš”_of
(
wÜk
, wb_io, work);

55 
io
->
”r_b™s
 = 0;

56 
io
->
”r
 = 
	`dm_io
(io->
io_»q
, io->
num_»giÚs
, io->
»giÚs
, &io->
”r_b™s
);

57 
	}
}

59 
	$wb_io_š‹º®
(
wb_deviû
 *
wb
, 
dm_io_»que¡
 *
io_»q
,

60 
num_»giÚs
, 
dm_io_»giÚ
 *
»giÚs
,

61 *
”r_b™s
, 
boŞ
 
th»ad
, cÚ¡ *
ÿÎ”
)

63 
”r
 = 0;

65 ià(
th»ad
) {

66 
wb_io
 
io
 = {

67 .
io_»q
 = io_req,

68 .
»giÚs
 =„egions,

69 .
num_»giÚs
 =‚um_regions,

71 
	`ASSERT
(
io_»q
->
nÙify
.
â
 =ğ
NULL
);

73 
	`INIT_WORK_ONSTACK
(&
io
.
wÜk
, 
wb_io_â
);

74 
	`queue_wÜk
(
wb
->
io_wq
, &
io
.
wÜk
);

75 
	`æush_wÜkqueue
(
wb
->
io_wq
);

76 
	`de¡roy_wÜk_Ú_¡ack
(&
io
.
wÜk
);

78 
”r
 = 
io
.err;

79 ià(
”r_b™s
)

80 *
”r_b™s
 = 
io
.err_bits;

82 
”r
 = 
	`dm_io
(
io_»q
, 
num_»giÚs
, 
»giÚs
, 
”r_b™s
);

86 ià(
”r
 || (
”r_b™s
 && *err_bits)) {

87 
buf
[
BDEVNAME_SIZE
];

88 
dev_t
 
dev
 = 
»giÚs
->
bdev
->
bd_dev
;

90 
eb
;

91 ià(!
”r_b™s
)

92 
eb
 = (~()0);

94 
eb
 = *
”r_b™s
;

96 
	`fÜm©_dev_t
(
buf
, 
dev
);

97 
	`DMERR
("%s() I/Oƒrror(%d), bits(%lu), dev(%s), sector(%llu), %s",

98 
ÿÎ”
, 
”r
, 
eb
,

99 
buf
, (è
»giÚs
->
£ùÜ
,

100 
	`»q_is_wr™e
(
io_»q
) ? "write" : "read");

103  
”r
;

104 
	}
}

106 
£ùÜ_t
 
	$dm_devsize
(
dm_dev
 *
dev
)

108  
	`i_size_»ad
(
dev
->
bdev
->
bd_šode
) >> 9;

109 
	}
}

113 
	$bio_io_sucûss_com·t
(
bio
 *bio)

115 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(4,13,0)

116 
bio
->
bi_¡©us
 = 
BLK_STS_OK
;

117 
	`bio_’dio
(
bio
);

118 #–ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(4,3,0)

119 
bio
->
bi_”rÜ
 = 0;

120 
	`bio_’dio
(
bio
);

122 
	`bio_’dio
(
bio
, 0);

124 
	}
}

126 #ià
LINUX_VERSION_CODE
 >ğ
KERNEL_VERSION
(3,14,0)

127 
	#bi_£ùÜ
(
bio
è(bio)->
bi_™”
.
bi_£ùÜ


	)

129 
	#bi_£ùÜ
(
bio
è(bio)->
bi_£ùÜ


	)

132 
	$bio_»m­
(
bio
 *bio, 
dm_dev
 *
dev
, 
£ùÜ_t
 
£ùÜ
)

134 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(4,14,0)

135 
	`bio_£t_dev
(
bio
, 
dev
->
bdev
);

137 
bio
->
bi_bdev
 = 
dev
->
bdev
;

139 
	`bi_£ùÜ
(
bio
èğ
£ùÜ
;

140 
	}
}

142 
u8
 
	$ÿlc_off£t
(
£ùÜ_t
 
£ùÜ
)

144 
u32
 
tmp32
;

145 
	`div_u64_»m
(
£ùÜ
, 1 << 3, &
tmp32
);

146  
tmp32
;

147 
	}
}

149 
u8
 
	$bio_ÿlc_off£t
(
bio
 *bio)

151  
	`ÿlc_off£t
(
	`bi_£ùÜ
(
bio
));

152 
	}
}

154 
boŞ
 
	$bio_is_fuÎsize
(
bio
 *bio)

156  
	`bio_£ùÜs
(
bio
) == (1 << 3);

157 
	}
}

159 
boŞ
 
	$bio_is_wr™e
(
bio
 *bio)

161  
	`bio_d©a_dœ
(
bio
è=ğ
WRITE
;

162 
	}
}

167 
£ùÜ_t
 
	$ÿlc_ÿche_®ignm’t
(
£ùÜ_t
 
bio_£ùÜ
)

170  
	`div_u64
(
bio_£ùÜ
, 1 << 3) * (1 << 3);

171 
	}
}

181 
	$wake_up_aùive_wq
(
wa™_queue_h—d_t
 *
wq
)

183 ià(
	`uÆik–y
(
	`wa™queue_aùive
(
wq
)))

184 
	`wake_up
(
wq
);

185 
	}
}

189 
u8
 
	$couÁ_dœty_ÿches_»mašed
(
£gm’t_h—d”
 *
£g
)

191 
u8
 
i
, 
couÁ
 = 0;

192 
m‘ablock
 *
mb
;

193 
i
 = 0; i < 
£g
->
Ëngth
; i++) {

194 
mb
 = 
£g
->
mb_¬¿y
 + 
i
;

195 ià(
mb
->
dœtšess
.
is_dœty
)

196 
couÁ
++;

198  
couÁ
;

199 
	}
}

201 
	$šc_Ä_dœty_ÿches
(
wb_deviû
 *
wb
)

203 
	`ASSERT
(
wb
);

204 
	`©omic64_šc
(&
wb
->
Ä_dœty_ÿches
);

205 
	}
}

207 
	$dec_Ä_dœty_ÿches
(
wb_deviû
 *
wb
)

209 
	`ASSERT
(
wb
);

210 ià(
	`©omic64_dec_ªd_‹¡
(&
wb
->
Ä_dœty_ÿches
))

211 
	`wake_up_š‹¼u±ibË
(&
wb
->
wa™_drİ_ÿches
);

212 
	}
}

214 
boŞ
 
	$št_mb
(
wb_deviû
 *
wb
, 
m‘ablock
 *
mb
, 
u8
 
d©a_b™s
)

216 
æags
;

217 
boŞ
 
æ³d
 = 
çl£
;

219 
	`ASSERT
(
d©a_b™s
 > 0);

220 
	`¥š_lock_œq§ve
(&
wb
->
mb_lock
, 
æags
);

222 ià(!
mb
->
dœtšess
.
is_dœty
) {

223 
mb
->
dœtšess
.
is_dœty
 = 
Œue
;

224 
æ³d
 = 
Œue
;

226 
mb
->
dœtšess
.
d©a_b™s
 |= data_bits;

227 
	`¥š_uÆock_œq»¡Üe
(&
wb
->
mb_lock
, 
æags
);

229  
æ³d
;

230 
	}
}

232 
boŞ
 
	$m¬k_ş—n_mb
(
wb_deviû
 *
wb
, 
m‘ablock
 *
mb
)

234 
æags
;

235 
boŞ
 
æ³d
 = 
çl£
;

237 
	`¥š_lock_œq§ve
(&
wb
->
mb_lock
, 
æags
);

238 ià(
mb
->
dœtšess
.
is_dœty
) {

239 
mb
->
dœtšess
.
is_dœty
 = 
çl£
;

240 
æ³d
 = 
Œue
;

242 
	`¥š_uÆock_œq»¡Üe
(&
wb
->
mb_lock
, 
æags
);

244  
æ³d
;

245 
	}
}

250 
dœtšess
 
	$»ad_mb_dœtšess
(
wb_deviû
 *
wb
, 
£gm’t_h—d”
 *
£g
,

251 
m‘ablock
 *
mb
)

253 
æags
;

254 
dœtšess
 
»tv®
;

256 
	`¥š_lock_œq§ve
(&
wb
->
mb_lock
, 
æags
);

257 
»tv®
 = 
mb
->
dœtšess
;

258 
	`¥š_uÆock_œq»¡Üe
(&
wb
->
mb_lock
, 
æags
);

260  
»tv®
;

261 
	}
}

265 
	$cursÜ_š™
(
wb_deviû
 *
wb
)

267 
wb
->
cursÜ
 = wb->
cu¼’t_£g
->
¡¬t_idx
;

268 
wb
->
cu¼’t_£g
->
Ëngth
 = 0;

269 
	}
}

275 
u32
 
	$advªû_cursÜ
(
wb_deviû
 *
wb
)

277 
u32
 
Şd
;

279 ià(
wb
->
cursÜ
 =ğwb->
Ä_ÿches
)

280 
wb
->
cursÜ
 = 0;

282 
Şd
 = 
wb
->
cursÜ
;

283 
wb
->
cursÜ
++;

284 
wb
->
cu¼’t_£g
->
Ëngth
++;

285 
	`BUG_ON
(
wb
->
cu¼’t_£g
->
Ëngth
 > wb->
Ä_ÿches_š£g
);

286 
	`©omic_šc
(&
wb
->
cu¼’t_£g
->
Ä_šæight_ios
);

287  
Şd
;

288 
	}
}

290 
boŞ
 
	$Ãeds_queue_£g
(
wb_deviû
 *
wb
)

292 
boŞ
 
¿mbuf_no_¥aû
 = !
	`mb_idx_š£g
(
wb
, wb->
cursÜ
);

294  
¿mbuf_no_¥aû
;

295 
	}
}

299 
	$cİy_b¬r›r_»que¡s
(
¿mbufãr
 *
¿mbuf
, 
wb_deviû
 *
wb
)

301 
	`bio_li¡_š™
(&
¿mbuf
->
b¬r›r_ios
);

302 
	`bio_li¡_m”ge
(&
¿mbuf
->
b¬r›r_ios
, &
wb
->barrier_ios);

303 
	`bio_li¡_š™
(&
wb
->
b¬r›r_ios
);

304 
	}
}

306 
	$´•¬e_¿mbufãr
(
¿mbufãr
 *
¿mbuf
,

307 
wb_deviû
 *
wb
,

308 
£gm’t_h—d”
 *
£g
)

310 
¿mbuf
->
£g
 = seg;

311 
	`´•¬e_£gm’t_h—d”_deviû
(
¿mbuf
->
d©a
, 
wb
, 
£g
);

312 
	`cİy_b¬r›r_»que¡s
(
¿mbuf
, 
wb
);

313 
	}
}

315 
	$š™_¿mbufãr
(
wb_deviû
 *
wb
)

317 
	`mem£t
(
wb
->
cu¼’t_¿mbuf
->
d©a
, 0, 1 << 12);

318 
	}
}

323 
	$__acquœe_Ãw_¿mbufãr
(
wb_deviû
 *
wb
, 
u64
 
id
)

325 
	`wa™_fÜ_æushšg
(
wb
, 
	`SUB_ID
(
id
, 
NR_RAMBUF_POOL
));

327 
wb
->
cu¼’t_¿mbuf
 = 
	`g‘_¿mbufãr_by_id
(wb, 
id
);

329 
	`š™_¿mbufãr
(
wb
);

330 
	}
}

332 
	$__acquœe_Ãw_£g
(
wb_deviû
 *
wb
, 
u64
 
id
)

334 
£gm’t_h—d”
 *
Ãw_£g
 = 
	`g‘_£gm’t_h—d”_by_id
(
wb
, 
id
);

340 
	`wa™_ev’t
(
wb
->
šæight_ios_wq
,

341 !
	`©omic_»ad
(&
Ãw_£g
->
Ä_šæight_ios
));

343 
	`wa™_fÜ_wr™eback
(
wb
, 
	`SUB_ID
(
id
, wb->
Ä_£gm’ts
));

344 ià(
	`couÁ_dœty_ÿches_»mašed
(
Ãw_£g
)) {

345 
	`DMERR
("%u dirty caches„emained. id:%llu",

346 
	`couÁ_dœty_ÿches_»mašed
(
Ãw_£g
), 
id
);

347 
	`BUG
();

349 
	`disÿrd_ÿches_š£g
(
wb
, 
Ãw_£g
);

355 
Ãw_£g
->
id
 = id;

356 
wb
->
cu¼’t_£g
 = 
Ãw_£g
;

357 
	}
}

364 
	$acquœe_Ãw_£g
(
wb_deviû
 *
wb
, 
u64
 
id
)

366 
	`__acquœe_Ãw_¿mbufãr
(
wb
, 
id
);

367 
	`__acquœe_Ãw_£g
(
wb
, 
id
);

368 
	}
}

370 
	$´•¬e_Ãw_£g
(
wb_deviû
 *
wb
)

372 
u64
 
Ãxt_id
 = 
wb
->
cu¼’t_£g
->
id
 + 1;

373 
	`acquœe_Ãw_£g
(
wb
, 
Ãxt_id
);

374 
	`cursÜ_š™
(
wb
);

375 
	}
}

379 
	$queue_æush_job
(
wb_deviû
 *
wb
)

381 
	`wa™_ev’t
(
wb
->
šæight_ios_wq
, !
	`©omic_»ad
(&wb->
cu¼’t_£g
->
Ä_šæight_ios
));

383 
	`´•¬e_¿mbufãr
(
wb
->
cu¼’t_¿mbuf
, wb, wb->
cu¼’t_£g
);

385 
	`smp_wmb
();

386 
	`©omic64_šc
(&
wb
->
Ï¡_queued_£gm’t_id
);

387 
	`wake_up_´oûss
(
wb
->
æush_d«mÚ
);

388 
	}
}

390 
	$queue_cu¼’t_bufãr
(
wb_deviû
 *
wb
)

392 
	`queue_æush_job
(
wb
);

393 
	`´•¬e_Ãw_£g
(
wb
);

394 
	}
}

399 
	$might_queue_cu¼’t_bufãr
(
wb_deviû
 *
wb
)

402 ià(
	`Ãeds_queue_£g
(
wb
)) {

403 
	`upd©e_Ä_em±y_£gs
(
wb
);

404 
	`queue_cu¼’t_bufãr
(
wb
);

406 
	}
}

411 
	$æush_cu¼’t_bufãr
(
wb_deviû
 *
wb
)

413 
£gm’t_h—d”
 *
Şd_£g
;

415 
	`mu‹x_lock
(&
wb
->
io_lock
);

416 
Şd_£g
 = 
wb
->
cu¼’t_£g
;

418 
	`queue_cu¼’t_bufãr
(
wb
);

419 
	`mu‹x_uÆock
(&
wb
->
io_lock
);

421 
	`wa™_fÜ_æushšg
(
wb
, 
Şd_£g
->
id
);

422 
	}
}

426 
	$šc_¡©
(
wb_deviû
 *
wb
,

427 
rw
, 
boŞ
 
found
, boŞ 
Ú_bufãr
, boŞ 
fuÎsize
)

429 
©omic64_t
 *
v
;

431 
i
 = 0;

432 ià(
rw
)

433 
i
 |ğ(1 << 
STAT_WRITE
);

434 ià(
found
)

435 
i
 |ğ(1 << 
STAT_HIT
);

436 ià(
Ú_bufãr
)

437 
i
 |ğ(1 << 
STAT_ON_BUFFER
);

438 ià(
fuÎsize
)

439 
i
 |ğ(1 << 
STAT_FULLSIZE
);

441 
v
 = &
wb
->
¡©
[
i
];

442 
	`©omic64_šc
(
v
);

443 
	}
}

445 
	$ş—r_¡©
(
wb_deviû
 *
wb
)

447 
size_t
 
i
;

448 
i
 = 0; i < 
STATLEN
; i++) {

449 
©omic64_t
 *
v
 = &
wb
->
¡©
[
i
];

450 
	`©omic64_£t
(
v
, 0);

452 
	`©omic64_£t
(&
wb
->
couÁ_nÚ_fuÎ_æushed
, 0);

453 
	}
}

457 #ià
LINUX_VERSION_CODE
 >ğ
KERNEL_VERSION
(3,14,0)

458 
	#bv_vec
 
bio_vec


	)

459 
	#bv_·ge
(
vec
èvec.
bv_·ge


	)

460 
	#bv_off£t
(
vec
èvec.
bv_off£t


	)

461 
	#bv_Ën
(
vec
èvec.
bv_Ën


	)

462 
	#bv_™
 
bvec_™”


	)

464 
	#bv_vec
 
bio_vec
 *

	)

465 
	#bv_·ge
(
vec
èvec->
bv_·ge


	)

466 
	#bv_off£t
(
vec
èvec->
bv_off£t


	)

467 
	#bv_Ën
(
vec
èvec->
bv_Ën


	)

468 
	#bv_™
 

	)

476 
	$cİy_bio_·ylßd
(*
buf
, 
bio
 *bio)

478 
size_t
 
sum
 = 0;

479 
bv_vec
 
vec
;

480 
bv_™
 
™
;

481 
	`bio_fÜ_—ch_£gm’t
(
vec
, 
bio
, 
™
) {

482 *
d¡
 = 
	`km­_©omic
(
	`bv_·ge
(
vec
));

483 
size_t
 
l
 = 
	`bv_Ën
(
vec
);

484 
	`memıy
(
buf
, 
d¡
 + 
	`bv_off£t
(
vec
), 
l
);

485 
	`kunm­_©omic
(
d¡
);

486 
buf
 +ğ
l
;

487 
sum
 +ğ
l
;

489 
	`ASSERT
(
sum
 =ğ(
	`bio_£ùÜs
(
bio
) << 9));

490 
	}
}

495 
	$__cİy_to_bio_·ylßd
(
bio
 *bio, *
buf
, 
u8
 
i
)

497 
size_t
 
h—d
 = 0;

498 
size_t
 

 = 
h—d
;

500 
bv_vec
 
vec
;

501 
bv_™
 
™
;

502 
	`bio_fÜ_—ch_£gm’t
(
vec
, 
bio
, 
™
) {

503 
size_t
 
l
 = 
	`bv_Ën
(
vec
);

504 

 +ğ
l
;

505 ià((
i
 << 9è< 

) {

506 *
d¡
 = 
	`km­_©omic
(
	`bv_·ge
(
vec
));

507 
size_t
 
off£t
 = (
i
 << 9è- 
h—d
;

508 
	`BUG_ON
((
l
 - 
off£t
) < (1 << 9));

509 
	`memıy
(
d¡
 + 
	`bv_off£t
(
vec
è+ 
off£t
, 
buf
, 1 << 9);

510 
	`kunm­_©omic
(
d¡
);

513 
h—d
 +ğ
l
;

515 
	`BUG
();

516 
	}
}

521 
	$cİy_to_bio_·ylßd
(
bio
 *bio, *
buf
, 
u8
 
cİy_b™s
)

523 
u8
 
off£t
 = 
	`bio_ÿlc_off£t
(
bio
);

524 
u8
 
i
;

525 
i
 = 0; i < 
	`bio_£ùÜs
(
bio
); i++) {

526 
u8
 
i_off£t
 = 
i
 + 
off£t
;

527 ià(
cİy_b™s
 & (1 << 
i_off£t
))

528 
	`__cİy_to_bio_·ylßd
(
bio
, 
buf
 + (
i_off£t
 << 9), 
i
);

530 
	}
}

534 
	slookup_»suÉ
 {

535 
ht_h—d
 *
	mh—d
;

536 
lookup_key
 
	mkey
;

538 
£gm’t_h—d”
 *
	mfound_£g
;

539 
m‘ablock
 *
	mfound_mb
;

541 
boŞ
 
	mfound
;

542 
boŞ
 
	mÚ_bufãr
;

549 
	$ÿche_lookup
(
wb_deviû
 *
wb
, 
bio
 *bio, 
lookup_»suÉ
 *
»s
)

551 
»s
->
key
 = (
lookup_key
) {

552 .
£ùÜ
 = 
	`ÿlc_ÿche_®ignm’t
(
	`bi_£ùÜ
(
bio
)),

554 
»s
->
h—d
 = 
	`ht_g‘_h—d
(
wb
, &»s->
key
);

556 
»s
->
found_mb
 = 
	`ht_lookup
(
wb
,„es->
h—d
, &»s->
key
);

557 ià(
»s
->
found_mb
) {

558 
»s
->
found_£g
 = 
	`mb_to_£g
(
wb
,„es->
found_mb
);

559 
	`©omic_šc
(&
»s
->
found_£g
->
Ä_šæight_ios
);

562 
»s
->
found
 = (»s->
found_mb
 !ğ
NULL
);

564 
»s
->
Ú_bufãr
 = 
çl£
;

565 ià(
»s
->
found
)

566 
»s
->
Ú_bufãr
 = 
	`is_Ú_bufãr
(
wb
,„es->
found_mb
->
idx
);

568 
	`šc_¡©
(
wb
, 
	`bio_is_wr™e
(
bio
), 
»s
->
found
,„es->
Ú_bufãr
, 
	`bio_is_fuÎsize
(bio));

569 
	}
}

571 
	$dec_šæight_ios
(
wb_deviû
 *
wb
, 
£gm’t_h—d”
 *
£g
)

573 ià(
	`©omic_dec_ªd_‹¡
(&
£g
->
Ä_šæight_ios
))

574 
	`wake_up_aùive_wq
(&
wb
->
šæight_ios_wq
);

575 
	}
}

579 
u8
 
	$to_mask
(
u8
 
off£t
, u8 
couÁ
)

581 
u8
 
i
;

582 
u8
 
»suÉ
 = 0;

583 ià(
couÁ
 == 8) {

584 
»suÉ
 = 255;

587 
i
 = 0; i < 
couÁ
; i++)

588 
»suÉ
 |ğ(1 << (
i
 + 
off£t
));

590  
»suÉ
;

591 
	}
}

593 
	$fl_·ylßd_by_backšg
(
wb_deviû
 *
wb
, 
bio
 *bio)

595 
dm_io_»que¡
 
io_»q
;

596 
dm_io_»giÚ
 
»giÚ
;

598 
£ùÜ_t
 
¡¬t
 = 
	`bi_£ùÜ
(
bio
);

599 
u8
 
off£t
 = 
	`ÿlc_off£t
(
¡¬t
);

600 
u8
 
Ën
 = 
	`bio_£ùÜs
(
bio
);

601 
u8
 
cİy_b™s
 = 
	`to_mask
(
off£t
, 
Ën
);

603 
”r
 = 0;

604 *
buf
 = 
	`mempoŞ_®loc
(
wb
->
buf_8_poŞ
, 
GFP_NOIO
);

605 ià(!
buf
)

606  -
ENOMEM
;

608 
io_»q
 = (
dm_io_»que¡
) {

609 
WB_IO_READ
,

610 .
ş›Á
 = 
wb
->
io_ş›Á
,

611 .
nÙify
.
â
 = 
NULL
,

612 .
mem
.
ty³
 = 
DM_IO_KMEM
,

613 .
mem
.
±r
.
addr
 = 
buf
 + (
off£t
 << 9),

615 
»giÚ
 = (
dm_io_»giÚ
) {

616 .
bdev
 = 
wb
->
backšg_dev
->bdev,

617 .
£ùÜ
 = 
¡¬t
,

618 .
couÁ
 = 
Ën
,

620 
”r
 = 
	`wb_io
(&
io_»q
, 1, &
»giÚ
, 
NULL
, 
Œue
);

621 ià(
”r
)

622 
bad
;

624 
	`cİy_to_bio_·ylßd
(
bio
, 
buf
, 
cİy_b™s
);

625 
bad
:

626 
	`mempoŞ_ä“
(
buf
, 
wb
->
buf_8_poŞ
);

627  
”r
;

628 
	}
}

634 *
	$»f_bufã»d_mb
(
wb_deviû
 *
wb
, 
m‘ablock
 *
mb
)

636 
£ùÜ_t
 
off£t
 = ((
	`mb_idx_š£g
(
wb
, 
mb
->
idx
) + 1) << 3);

637  
wb
->
cu¼’t_¿mbuf
->
d©a
 + (
off£t
 << 9);

638 
	}
}

644 *
	$»ad_mb
(
wb_deviû
 *
wb
, 
£gm’t_h—d”
 *
£g
,

645 
m‘ablock
 *
mb
, 
u8
 
d©a_b™s
)

647 
u8
 
i
;

648 *
»suÉ
 = 
	`mempoŞ_®loc
(
wb
->
buf_8_poŞ
, 
GFP_NOIO
);

649 ià(!
»suÉ
)

650  
NULL
;

652 
i
 = 0; i < 8; i++) {

653 
”r
 = 0;

654 
dm_io_»que¡
 
io_»q
;

655 
dm_io_»giÚ
 
»giÚ
;

657 ià(!(
d©a_b™s
 & (1 << 
i
)))

660 
io_»q
 = (
dm_io_»que¡
) {

661 
WB_IO_READ
,

662 .
ş›Á
 = 
wb
->
io_ş›Á
,

663 .
nÙify
.
â
 = 
NULL
,

664 .
mem
.
ty³
 = 
DM_IO_KMEM
,

665 .
mem
.
±r
.
addr
 = 
»suÉ
 + (
i
 << 9),

668 
»giÚ
 = (
dm_io_»giÚ
) {

669 .
bdev
 = 
wb
->
ÿche_dev
->bdev,

670 .
£ùÜ
 = 
	`ÿlc_mb_¡¬t_£ùÜ
(
wb
, 
£g
, 
mb
->
idx
è+ 
i
,

671 .
couÁ
 = 1,

674 
”r
 = 
	`wb_io
(&
io_»q
, 1, &
»giÚ
, 
NULL
, 
Œue
);

675 ià(
”r
) {

676 
	`mempoŞ_ä“
(
»suÉ
, 
wb
->
buf_8_poŞ
);

677  
NULL
;

680  
»suÉ
;

681 
	}
}

685 
	ePBD_FLAG
 {

686 
	mPBD_NONE
 = 0,

687 
	mPBD_WILL_CACHE
 = 1,

688 
	mPBD_READ_SEG
 = 2,

691 #ià(
LINUX_VERSION_CODE
 >ğ
KERNEL_VERSION
(4,6,0è|| 
RHEL_RELEASE_CODE
 >ğ
RHEL_RELEASE_VERSION
(7,3))

692 
	#PER_BIO_DATA_SIZE
 
³r_io_d©a_size


	)

694 
	#PER_BIO_DATA_SIZE
 
³r_bio_d©a_size


	)

696 
	s³r_bio_d©a
 {

697 
PBD_FLAG
 
	mty³
;

699 
u32
 
	mûÎ_idx
;

700 
£gm’t_h—d”
 *
	m£g
;

703 
	#³r_bio_d©a
(
wb
, 
bio
è((
³r_bio_d©a
 *)
	`dm_³r_bio_d©a
((bio), (wb)->
ti
->
PER_BIO_DATA_SIZE
))

	)

707 
	#»ad_ÿche_ûÎ_äom_node
(
node
è
	`rb_’Œy
(Òode), 
»ad_ÿche_ûÎ
, 
rb_node
)

	)

709 
	$»ad_ÿche_add
(
»ad_ÿche_ûÎs
 *
ûÎs
, 
»ad_ÿche_ûÎ
 *
ûÎ
)

711 
rb_node
 **
rbp
, *
·»Á
;

712 
rbp
 = &
ûÎs
->
rb_roÙ
.
rb_node
;

713 
·»Á
 = 
NULL
;

714 *
rbp
) {

715 
»ad_ÿche_ûÎ
 *
·»Á_ûÎ
;

716 
·»Á
 = *
rbp
;

717 
·»Á_ûÎ
 = 
	`»ad_ÿche_ûÎ_äom_node
(
·»Á
);

718 ià(
ûÎ
->
£ùÜ
 < 
·»Á_ûÎ
->sector)

719 
rbp
 = &(*rbp)->
rb_Ëá
;

721 
rbp
 = &(*rbp)->
rb_right
;

723 
	`rb_lšk_node
(&
ûÎ
->
rb_node
, 
·»Á
, 
rbp
);

724 
	`rb_š£¹_cŞÜ
(&
ûÎ
->
rb_node
, &
ûÎs
->
rb_roÙ
);

725 
	}
}

727 
»ad_ÿche_ûÎ
 *
	$lookup_»ad_ÿche_ûÎ
(
wb_deviû
 *
wb
, 
£ùÜ_t
 
£ùÜ
)

729 
rb_node
 **
rbp
, *
·»Á
;

730 
rbp
 = &
wb
->
»ad_ÿche_ûÎs
->
rb_roÙ
.
rb_node
;

731 
·»Á
 = 
NULL
;

732 *
rbp
) {

733 
»ad_ÿche_ûÎ
 *
·»Á_ûÎ
;

734 
·»Á
 = *
rbp
;

735 
·»Á_ûÎ
 = 
	`»ad_ÿche_ûÎ_äom_node
(
·»Á
);

736 ià(
·»Á_ûÎ
->
£ùÜ
 == sector)

737  
·»Á_ûÎ
;

739 ià(
£ùÜ
 < 
·»Á_ûÎ
->sector)

740 
rbp
 = &(*rbp)->
rb_Ëá
;

742 
rbp
 = &(*rbp)->
rb_right
;

744  
NULL
;

745 
	}
}

747 
	$»ad_ÿche_ÿnûl_ûÎs
(
»ad_ÿche_ûÎs
 *
ûÎs
, 
u32
 
n
)

749 
u32
 
i
;

750 
u32
 
Ï¡
 = 
ûÎs
->
cursÜ
 + c–ls->
£qcouÁ
;

751 ià(
Ï¡
 > 
ûÎs
->
size
)

752 
Ï¡
 = 
ûÎs
->
size
;

753 
i
 = 
ûÎs
->
cursÜ
; i < 
Ï¡
; i++) {

754 
»ad_ÿche_ûÎ
 *
ûÎ
 = 
ûÎs
->
¬¿y
 + 
i
;

755 
ûÎ
->
ÿnûÎed
 = 
Œue
;

757 
	}
}

763 
	$»ad_ÿche_ÿnûl_fÜeground
(
»ad_ÿche_ûÎs
 *
ûÎs
,

764 
»ad_ÿche_ûÎ
 *
Ãw_ûÎ
)

766 ià(
Ãw_ûÎ
->
£ùÜ
 =ğ(
ûÎs
->
Ï¡_£ùÜ
 + 8))

767 
ûÎs
->
£qcouÁ
++;

769 
ûÎs
->
£qcouÁ
 = 1;

770 
ûÎs
->
ov”_th»shŞd
 = 
çl£
;

773 ià(
ûÎs
->
£qcouÁ
 > c–ls->
th»shŞd
) {

774 ià(
ûÎs
->
ov”_th»shŞd
)

775 
Ãw_ûÎ
->
ÿnûÎed
 = 
Œue
;

777 
ûÎs
->
ov”_th»shŞd
 = 
Œue
;

778 
	`»ad_ÿche_ÿnûl_ûÎs
(
ûÎs
, c–ls->
£qcouÁ
);

781 
ûÎs
->
Ï¡_£ùÜ
 = 
Ãw_ûÎ
->
£ùÜ
;

782 
	}
}

784 
boŞ
 
	$»£rve_»ad_ÿche_ûÎ
(
wb_deviû
 *
wb
, 
bio
 *bio)

786 
³r_bio_d©a
 *
pbd
;

787 
»ad_ÿche_ûÎs
 *
ûÎs
 = 
wb
->read_cache_cells;

788 
»ad_ÿche_ûÎ
 *
found
, *
Ãw_ûÎ
;

790 
	`ASSERT
(
ûÎs
->
th»shŞd
 > 0);

792 ià(!
	`ACCESS_ONCE
(
wb
->
»ad_ÿche_th»shŞd
))

793  
çl£
;

795 ià(!
ûÎs
->
cursÜ
)

796  
çl£
;

803 ià(!
	`bio_is_fuÎsize
(
bio
))

804  
çl£
;

810 
found
 = 
	`lookup_»ad_ÿche_ûÎ
(
wb
, 
	`bi_£ùÜ
(
bio
));

811 ià(
found
)

812  
çl£
;

814 
ûÎs
->
cursÜ
--;

815 
Ãw_ûÎ
 = 
ûÎs
->
¬¿y
 + c–ls->
cursÜ
;

816 
Ãw_ûÎ
->
£ùÜ
 = 
	`bi_£ùÜ
(
bio
);

817 
	`»ad_ÿche_add
(
ûÎs
, 
Ãw_ûÎ
);

819 
pbd
 = 
	`³r_bio_d©a
(
wb
, 
bio
);

820 
pbd
->
ty³
 = 
PBD_WILL_CACHE
;

821 
pbd
->
ûÎ_idx
 = 
ûÎs
->
cursÜ
;

824 
	`»ad_ÿche_ÿnûl_fÜeground
(
ûÎs
, 
Ãw_ûÎ
);

826  
Œue
;

827 
	}
}

829 
	$might_ÿnûl_»ad_ÿche_ûÎ
(
wb_deviû
 *
wb
, 
bio
 *bio)

831 
»ad_ÿche_ûÎ
 *
found
;

832 
found
 = 
	`lookup_»ad_ÿche_ûÎ
(
wb
, 
	`ÿlc_ÿche_®ignm’t
(
	`bi_£ùÜ
(
bio
)));

833 ià(
found
)

834 
found
->
ÿnûÎed
 = 
Œue
;

835 
	}
}

837 
	$»ad_ÿche_ûÎ_cİy_d©a
(
wb_deviû
 *
wb
, 
bio
 *bio, 
”rÜ
)

839 
³r_bio_d©a
 *
pbd
 = 
	`³r_bio_d©a
(
wb
, 
bio
);

840 
»ad_ÿche_ûÎs
 *
ûÎs
 = 
wb
->read_cache_cells;

841 
»ad_ÿche_ûÎ
 *
ûÎ
 = 
ûÎs
->
¬¿y
 + 
pbd
->
ûÎ_idx
;

843 
	`ASSERT
(
pbd
->
ty³
 =ğ
PBD_WILL_CACHE
);

846 ià(
”rÜ
)

847 
ûÎ
->
ÿnûÎed
 = 
Œue
;

854 ià(!
ûÎ
->
ÿnûÎed
)

855 
	`cİy_bio_·ylßd
(
ûÎ
->
d©a
, 
bio
);

857 ià(
	`©omic_dec_ªd_‹¡
(&
ûÎs
->
ack_couÁ
))

858 
	`queue_wÜk
(
ûÎs
->
wq
, &
wb
->
»ad_ÿche_wÜk
);

859 
	}
}

864 
	$šjeù_»ad_ÿche
(
wb_deviû
 *
wb
, 
»ad_ÿche_ûÎ
 *
ûÎ
)

866 
m‘ablock
 *
mb
;

867 
u32
 
_mb_idx_š£g
;

868 
£gm’t_h—d”
 *
£g
;

870 
lookup_key
 
key
 = {

871 .
£ùÜ
 = 
ûÎ
->sector,

873 
ht_h—d
 *
h—d
 = 
	`ht_g‘_h—d
(
wb
, &
key
);

875 
	`mu‹x_lock
(&
wb
->
io_lock
);

880 ià(
ûÎ
->
ÿnûÎed
) {

881 
	`mu‹x_uÆock
(&
wb
->
io_lock
);

885 
	`might_queue_cu¼’t_bufãr
(
wb
);

887 
£g
 = 
wb
->
cu¼’t_£g
;

888 
_mb_idx_š£g
 = 
	`mb_idx_š£g
(
wb
, 
	`advªû_cursÜ
(wb));

895 
	`memıy
(
wb
->
cu¼’t_¿mbuf
->
d©a
 + ((
_mb_idx_š£g
 + 1è<< 12), 
ûÎ
->data, 1 << 12);

897 
mb
 = 
£g
->
mb_¬¿y
 + 
_mb_idx_š£g
;

898 
	`ASSERT
(!
mb
->
dœtšess
.
is_dœty
);

899 
mb
->
dœtšess
.
d©a_b™s
 = 255;

901 
	`ht_»gi¡”
(
wb
, 
h—d
, 
mb
, &
key
);

903 
	`mu‹x_uÆock
(&
wb
->
io_lock
);

905 
	`dec_šæight_ios
(
wb
, 
£g
);

906 
	}
}

908 
	$ä“_»ad_ÿche_ûÎ_d©a
(
»ad_ÿche_ûÎs
 *
ûÎs
)

910 
u32
 
i
;

911 
i
 = 0; i < 
ûÎs
->
size
; i++) {

912 
»ad_ÿche_ûÎ
 *
ûÎ
 = 
ûÎs
->
¬¿y
 + 
i
;

913 
	`vä“
(
ûÎ
->
d©a
);

915 
	}
}

917 
»ad_ÿche_ûÎs
 *
	$®loc_»ad_ÿche_ûÎs
(
wb_deviû
 *
wb
, 
u32
 
n
)

919 
»ad_ÿche_ûÎs
 *
ûÎs
;

920 
u32
 
i
;

921 
ûÎs
 = 
	`km®loc
((
»ad_ÿche_ûÎs
), 
GFP_KERNEL
);

922 ià(!
ûÎs
)

923  
NULL
;

925 
ûÎs
->
size
 = 
n
;

926 
ûÎs
->
th»shŞd
 = 
UINT_MAX
;

927 
ûÎs
->
Ï¡_£ùÜ
 = ~0;

928 
ûÎs
->
£qcouÁ
 = 0;

929 
ûÎs
->
ov”_th»shŞd
 = 
çl£
;

930 
ûÎs
->
¬¿y
 = 
	`km®loc
((
»ad_ÿche_ûÎ
è* 
n
, 
GFP_KERNEL
);

931 ià(!
ûÎs
->
¬¿y
)

932 
bad_ûÎs_¬¿y
;

934 
i
 = 0; i < 
ûÎs
->
size
; i++) {

935 
»ad_ÿche_ûÎ
 *
ûÎ
 = 
ûÎs
->
¬¿y
 + 
i
;

936 
ûÎ
->
d©a
 = 
	`vm®loc
(1 << 12);

937 ià(!
ûÎ
->
d©a
) {

938 
u32
 
j
;

939 
j
 = 0; j < 
i
; j++) {

940 
ûÎ
 = 
ûÎs
->
¬¿y
 + 
j
;

941 
	`vä“
(
ûÎ
->
d©a
);

943 
bad_ûÎ_d©a
;

947 
ûÎs
->
wq
 = 
	`ü—‹_sšgËth»ad_wÜkqueue
("dmwb_read_cache");

948 ià(!
ûÎs
->
wq
)

949 
bad_wq
;

951  
ûÎs
;

953 
bad_wq
:

954 
	`ä“_»ad_ÿche_ûÎ_d©a
(
ûÎs
);

955 
bad_ûÎ_d©a
:

956 
	`kä“
(
ûÎs
->
¬¿y
);

957 
bad_ûÎs_¬¿y
:

958 
	`kä“
(
ûÎs
);

959  
NULL
;

960 
	}
}

962 
	$ä“_»ad_ÿche_ûÎs
(
wb_deviû
 *
wb
)

964 
»ad_ÿche_ûÎs
 *
ûÎs
 = 
wb
->read_cache_cells;

965 
	`de¡roy_wÜkqueue
(
ûÎs
->
wq
);

966 
	`ä“_»ad_ÿche_ûÎ_d©a
(
ûÎs
);

967 
	`kä“
(
ûÎs
->
¬¿y
);

968 
	`kä“
(
ûÎs
);

969 
	}
}

971 
	$»š™_»ad_ÿche_ûÎs
(
wb_deviû
 *
wb
)

973 
»ad_ÿche_ûÎs
 *
ûÎs
 = 
wb
->read_cache_cells;

974 
u32
 
i
, 
cur_th»shŞd
;

976 
	`mu‹x_lock
(&
wb
->
io_lock
);

977 
ûÎs
->
rb_roÙ
 = 
RB_ROOT
;

978 
ûÎs
->
cursÜ
 = c–ls->
size
;

979 
	`©omic_£t
(&
ûÎs
->
ack_couÁ
, c–ls->
size
);

980 
i
 = 0; i < 
ûÎs
->
size
; i++) {

981 
»ad_ÿche_ûÎ
 *
ûÎ
 = 
ûÎs
->
¬¿y
 + 
i
;

982 
ûÎ
->
ÿnûÎed
 = 
çl£
;

984 
cur_th»shŞd
 = 
	`ACCESS_ONCE
(
wb
->
»ad_ÿche_th»shŞd
);

985 ià(
cur_th»shŞd
 && (cur_th»shŞd !ğ
ûÎs
->
th»shŞd
)) {

986 
ûÎs
->
th»shŞd
 = 
cur_th»shŞd
;

987 
ûÎs
->
ov”_th»shŞd
 = 
çl£
;

989 
	`mu‹x_uÆock
(&
wb
->
io_lock
);

990 
	}
}

995 
	$vis™_ªd_ÿnûl_ûÎs
(
rb_node
 *
fœ¡
, rb_nod*
Ï¡
)

997 
rb_node
 *
rbp
 = 
fœ¡
;

998 
rbp
 !ğ
Ï¡
) {

999 
»ad_ÿche_ûÎ
 *
ûÎ
 = 
	`»ad_ÿche_ûÎ_äom_node
(
rbp
);

1000 
ûÎ
->
ÿnûÎed
 = 
Œue
;

1001 
rbp
 = 
	`rb_Ãxt
(rbp);

1003 
	}
}

1008 
	$»ad_ÿche_ÿnûl_background
(
»ad_ÿche_ûÎs
 *
ûÎs
)

1010 
rb_node
 *
rbp
 = 
	`rb_fœ¡
(&
ûÎs
->
rb_roÙ
);

1011 
rb_node
 *
£qh—d
 = 
rbp
;

1012 
£ùÜ_t
 
Ï¡_£ùÜ
 = ~0;

1013 
u32
 
£qcouÁ
 = 0;

1015 
rbp
) {

1016 
»ad_ÿche_ûÎ
 *
ûÎ
 = 
	`»ad_ÿche_ûÎ_äom_node
(
rbp
);

1017 ià(
ûÎ
->
£ùÜ
 =ğ(
Ï¡_£ùÜ
 + 8))

1018 
£qcouÁ
++;

1020 ià(
£qcouÁ
 > 
ûÎs
->
th»shŞd
)

1021 
	`vis™_ªd_ÿnûl_ûÎs
(
£qh—d
, 
rbp
);

1022 
£qcouÁ
 = 1;

1023 
£qh—d
 = 
rbp
;

1025 
Ï¡_£ùÜ
 = 
ûÎ
->
£ùÜ
;

1026 
rbp
 = 
	`rb_Ãxt
(rbp);

1028 ià(
£qcouÁ
 > 
ûÎs
->
th»shŞd
)

1029 
	`vis™_ªd_ÿnûl_ûÎs
(
£qh—d
, 
rbp
);

1030 
	}
}

1032 
	$»ad_ÿche_´oc
(
wÜk_¡ruù
 *
wÜk
)

1034 
wb_deviû
 *
wb
 = 
	`cÚš”_of
(
wÜk
, wb_deviû, 
»ad_ÿche_wÜk
);

1035 
»ad_ÿche_ûÎs
 *
ûÎs
 = 
wb
->read_cache_cells;

1036 
u32
 
i
;

1038 
	`»ad_ÿche_ÿnûl_background
(
ûÎs
);

1040 
i
 = 0; i < 
ûÎs
->
size
; i++) {

1041 
»ad_ÿche_ûÎ
 *
ûÎ
 = 
ûÎs
->
¬¿y
 + 
i
;

1042 
	`šjeù_»ad_ÿche
(
wb
, 
ûÎ
);

1045 
	`»š™_»ad_ÿche_ûÎs
(
wb
);

1046 
	}
}

1048 
	$š™_»ad_ÿche_ûÎs
(
wb_deviû
 *
wb
)

1050 
»ad_ÿche_ûÎs
 *
ûÎs
;

1051 
	`INIT_WORK
(&
wb
->
»ad_ÿche_wÜk
, 
»ad_ÿche_´oc
);

1052 
ûÎs
 = 
	`®loc_»ad_ÿche_ûÎs
(
wb
, wb->
Ä_»ad_ÿche_ûÎs
);

1053 ià(!
ûÎs
)

1054  -
ENOMEM
;

1055 
wb
->
»ad_ÿche_ûÎs
 = 
ûÎs
;

1056 
	`»š™_»ad_ÿche_ûÎs
(
wb
);

1058 
	}
}

1062 
	$š™Ÿlize_wr™e_io
(
wr™e_io
 *
wio
, 
bio
 *bio)

1064 
u8
 
off£t
 = 
	`bio_ÿlc_off£t
(
bio
);

1065 
£ùÜ_t
 
couÁ
 = 
	`bio_£ùÜs
(
bio
);

1073 
	`cİy_bio_·ylßd
(
wio
->
d©a
 + (
off£t
 << 9), 
bio
);

1076 
wio
->
d©a_b™s
 = 
	`to_mask
(
off£t
, 
couÁ
);

1077 
	}
}

1079 
	$memıy_masked
(*
to
, 
u8
 
´Ùeù_b™s
, *
äom
, u8 
cİy_b™s
)

1081 
u8
 
i
;

1082 
i
 = 0; i < 8; i++) {

1083 
boŞ
 
wl_cİy
 = 
cİy_b™s
 & (1 << 
i
);

1084 
boŞ
 
´Ùeùed
 = 
´Ùeù_b™s
 & (1 << 
i
);

1085 ià(
wl_cİy
 && (!
´Ùeùed
)) {

1086 
size_t
 
off£t
 = (
i
 << 9);

1087 
	`memıy
(
to
 + 
off£t
, 
äom
 + offset, 1 << 9);

1090 
	}
}

1092 
	$´•¬e_ov”wr™e
(
wb_deviû
 *
wb
, 
£gm’t_h—d”
 *
£g
, 
m‘ablock
 *
Şd_mb
, 
wr™e_io
* 
wio
, 
u8
 
ov”wr™e_b™s
)

1094 
dœtšess
 dœtšes ğ
	`»ad_mb_dœtšess
(
wb
, 
£g
, 
Şd_mb
);

1096 
boŞ
 
Ãeds_m”ge_´ev_ÿche
 = !(
ov”wr™e_b™s
 =ğ255è|| !(
dœtšess
.
d©a_b™s
 == 255);

1098 ià(!
dœtšess
.
is_dœty
)

1099 
Ãeds_m”ge_´ev_ÿche
 = 
çl£
;

1101 ià(
ov”wr™e_b™s
 == 255)

1102 
Ãeds_m”ge_´ev_ÿche
 = 
çl£
;

1104 ià(
	`uÆik–y
(
Ãeds_m”ge_´ev_ÿche
)) {

1105 *
buf
;

1107 
	`wa™_fÜ_æushšg
(
wb
, 
£g
->
id
);

1108 
	`ASSERT
(
dœtšess
.
is_dœty
);

1110 
buf
 = 
	`»ad_mb
(
wb
, 
£g
, 
Şd_mb
, 
dœtšess
.
d©a_b™s
);

1111 ià(!
buf
)

1112  -
EIO
;

1115 
	`memıy_masked
(
wio
->
d©a
, wio->
d©a_b™s
, 
buf
, 
dœtšess
.data_bits);

1116 
wio
->
d©a_b™s
 |ğ
dœtšess
.data_bits;

1117 
	`mempoŞ_ä“
(
buf
, 
wb
->
buf_8_poŞ
);

1120 ià(
	`m¬k_ş—n_mb
(
wb
, 
Şd_mb
))

1121 
	`dec_Ä_dœty_ÿches
(
wb
);

1123 
	`ht_d–
(
wb
, 
Şd_mb
);

1126 
	}
}

1131 
m‘ablock
 *
	$´•¬e_Ãw_wr™e_pos
(
wb_deviû
 *
wb
)

1133 
m‘ablock
 *
»t
 = 
wb
->
cu¼’t_£g
->
mb_¬¿y
 + 
	`mb_idx_š£g
(wb, 
	`advªû_cursÜ
(wb));

1134 
	`ASSERT
(!
»t
->
dœtšess
.
is_dœty
);

1135 
»t
->
dœtšess
.
d©a_b™s
 = 0;

1136  
»t
;

1137 
	}
}

1139 
	$wr™e_Ú_¿mbufãr
(
wb_deviû
 *
wb
, 
m‘ablock
 *
wr™e_pos
, 
wr™e_io
 *
wio
)

1141 
size_t
 
mb_off£t
 = (
	`mb_idx_š£g
(
wb
, 
wr™e_pos
->
idx
) + 1) << 12;

1142 *
mb_d©a
 = 
wb
->
cu¼’t_¿mbuf
->
d©a
 + 
mb_off£t
;

1143 ià(
wio
->
d©a_b™s
 == 255)

1144 
	`memıy
(
mb_d©a
, 
wio
->
d©a
, 1 << 12);

1146 
	`memıy_masked
(
mb_d©a
, 0, 
wio
->
d©a
, wio->
d©a_b™s
);

1147 
	}
}

1149 
	$do_´oûss_wr™e
(
wb_deviû
 *
wb
, 
bio
 *bio)

1151 
”r
 = 0;

1153 
m‘ablock
 *
wr™e_pos
 = 
NULL
;

1154 
lookup_»suÉ
 
»s
;

1156 
wr™e_io
 
wio
;

1157 
wio
.
d©a
 = 
	`mempoŞ_®loc
(
wb
->
buf_8_poŞ
, 
GFP_NOIO
);

1158 ià(!
wio
.
d©a
)

1159  -
ENOMEM
;

1161 
	`š™Ÿlize_wr™e_io
(&
wio
, 
bio
);

1163 
	`mu‹x_lock
(&
wb
->
io_lock
);

1165 
	`ÿche_lookup
(
wb
, 
bio
, &
»s
);

1167 ià(
»s
.
found
) {

1168 ià(
	`uÆik–y
(
»s
.
Ú_bufãr
)) {

1170 
wr™e_pos
 = 
»s
.
found_mb
;

1171 
do_wr™e
;

1173 
”r
 = 
	`´•¬e_ov”wr™e
(
wb
, 
»s
.
found_£g
,„es.
found_mb
, &
wio
, wio.
d©a_b™s
);

1174 
	`dec_šæight_ios
(
wb
, 
»s
.
found_£g
);

1175 ià(
”r
)

1176 
out
;

1179 
	`might_ÿnûl_»ad_ÿche_ûÎ
(
wb
, 
bio
);

1181 
	`might_queue_cu¼’t_bufãr
(
wb
);

1183 
wr™e_pos
 = 
	`´•¬e_Ãw_wr™e_pos
(
wb
);

1185 
do_wr™e
:

1186 
	`ASSERT
(
wr™e_pos
);

1187 
	`wr™e_Ú_¿mbufãr
(
wb
, 
wr™e_pos
, &
wio
);

1189 ià(
	`št_mb
(
wb
, 
wr™e_pos
, 
wio
.
d©a_b™s
))

1190 
	`šc_Ä_dœty_ÿches
(
wb
);

1192 
	`ht_»gi¡”
(
wb
, 
»s
.
h—d
, 
wr™e_pos
, &»s.
key
);

1194 
out
:

1195 
	`mu‹x_uÆock
(&
wb
->
io_lock
);

1196 
	`mempoŞ_ä“
(
wio
.
d©a
, 
wb
->
buf_8_poŞ
);

1197  
”r
;

1198 
	}
}

1200 
	$com¶‘e_´oûss_wr™e
(
wb_deviû
 *
wb
, 
bio
 *bio)

1202 
	`dec_šæight_ios
(
wb
, wb->
cu¼’t_£g
);

1208 ià(
	`bio_is_fua
(
bio
)) {

1209 
	`queue_b¬r›r_io
(
wb
, 
bio
);

1210  
DM_MAPIO_SUBMITTED
;

1213 
	`bio_io_sucûss_com·t
(
bio
);

1214  
DM_MAPIO_SUBMITTED
;

1215 
	}
}

1248 
	$´oûss_wr™e_wb
(
wb_deviû
 *
wb
, 
bio
 *bio)

1251 
”r
 = 
	`do_´oûss_wr™e
(
wb
, 
bio
);

1252 ià(
”r
) {

1253 
	`bio_io_”rÜ
(
bio
);

1254  
DM_MAPIO_SUBMITTED
;

1256  
	`com¶‘e_´oûss_wr™e
(
wb
, 
bio
);

1257 
	}
}

1259 
	$´oûss_wr™e_wa
(
wb_deviû
 *
wb
, 
bio
 *bio)

1261 
lookup_»suÉ
 
»s
;

1263 
	`mu‹x_lock
(&
wb
->
io_lock
);

1264 
	`ÿche_lookup
(
wb
, 
bio
, &
»s
);

1265 ià(
»s
.
found
) {

1266 
	`dec_šæight_ios
(
wb
, 
»s
.
found_£g
);

1267 
	`ht_d–
(
wb
, 
»s
.
found_mb
);

1270 
	`might_ÿnûl_»ad_ÿche_ûÎ
(
wb
, 
bio
);

1271 
	`mu‹x_uÆock
(&
wb
->
io_lock
);

1273 
	`bio_»m­
(
bio
, 
wb
->
backšg_dev
, 
	`bi_£ùÜ
(bio));

1274  
DM_MAPIO_REMAPPED
;

1275 
	}
}

1284 
	$´oûss_wr™e
(
wb_deviû
 *
wb
, 
bio
 *bio)

1289  
wb
->
wr™e_¬ound_mode
 ? 
	`´oûss_wr™e_wa
(wb, 
bio
è: 
	`´oûss_wr™e_wb
(wb, bio);

1290 
	}
}

1292 
	s»ad_backšg_async_cÚ‹xt
 {

1293 
wb_deviû
 *
	mwb
;

1294 
bio
 *
	mbio
;

1297 
	$»ad_backšg_async_ÿÎback_Ú¡ack
(
”rÜ
, 
»ad_backšg_async_cÚ‹xt
 *
ùx
)

1299 
	`ASSERT
(
	`bio_is_fuÎsize
(
ùx
->
bio
));

1301 
	`»ad_ÿche_ûÎ_cİy_d©a
(
ùx
->
wb
, ctx->
bio
, 
”rÜ
);

1303 ià(
”rÜ
)

1304 
	`bio_io_”rÜ
(
ùx
->
bio
);

1306 
	`bio_io_sucûss_com·t
(
ùx
->
bio
);

1307 
	}
}

1309 
	$»ad_backšg_async_ÿÎback
(
”rÜ
, *
cÚ‹xt
)

1311 
»ad_backšg_async_cÚ‹xt
 *
ùx
 = 
cÚ‹xt
;

1312 
	`»ad_backšg_async_ÿÎback_Ú¡ack
(
”rÜ
, 
ùx
);

1313 
	`kä“
(
ùx
);

1314 
	}
}

1316 
	$»ad_backšg_async
(
wb_deviû
 *
wb
, 
bio
 *bio)

1318 
”r
 = 0;

1320 
dm_io_»que¡
 
io_»q
;

1321 
dm_io_»giÚ
 
»giÚ
;

1323 
»ad_backšg_async_cÚ‹xt
 *
ùx
 = 
	`km®loc
((»ad_backšg_async_cÚ‹xt), 
GFP_NOIO
);

1324 ià(!
ùx
)

1325  -
ENOMEM
;

1327 
ùx
->
wb
 = wb;

1328 
ùx
->
bio
 = bio;

1330 
	`ASSERT
(
	`bio_is_fuÎsize
(
bio
));

1332 
io_»q
 = (
dm_io_»que¡
) {

1333 
WB_IO_READ
,

1334 .
ş›Á
 = 
wb
->
io_ş›Á
,

1335 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(3,14,0)

1336 .
mem
.
ty³
 = 
DM_IO_BIO
,

1337 .
mem
.
±r
.
bio
 = bio,

1339 .
mem
.
ty³
 = 
DM_IO_BVEC
,

1340 .
mem
.
±r
.
bvec
 = 
bio
->
bi_io_vec
 + bio->
bi_idx
,

1342 .
nÙify
.
â
 = 
»ad_backšg_async_ÿÎback
,

1343 .
nÙify
.
cÚ‹xt
 = 
ùx


1345 
»giÚ
 = (
dm_io_»giÚ
) {

1346 .
bdev
 = 
wb
->
backšg_dev
->bdev,

1347 .
£ùÜ
 = 
	`bi_£ùÜ
(
bio
),

1348 .
couÁ
 = 8

1351 
”r
 = 
	`wb_io
(&
io_»q
, 1, &
»giÚ
, 
NULL
, 
çl£
);

1352 ià(
”r
)

1353 
	`kä“
(
ùx
);

1355  
”r
;

1356 
	}
}

1358 
	$´oûss_»ad
(
wb_deviû
 *
wb
, 
bio
 *bio)

1360 
lookup_»suÉ
 
»s
;

1361 
dœtšess
 dirtiness;

1362 
³r_bio_d©a
 *
pbd
;

1364 
boŞ
 
»£rved
 = 
çl£
;

1366 
	`mu‹x_lock
(&
wb
->
io_lock
);

1367 
	`ÿche_lookup
(
wb
, 
bio
, &
»s
);

1368 ià(!
»s
.
found
)

1369 
»£rved
 = 
	`»£rve_»ad_ÿche_ûÎ
(
wb
, 
bio
);

1370 
	`mu‹x_uÆock
(&
wb
->
io_lock
);

1372 ià(!
»s
.
found
) {

1373 ià(
»£rved
) {

1380 ià(
	`»ad_backšg_async
(
wb
, 
bio
)) {

1381 
»ad_backšg_async_cÚ‹xt
 
ùx
 = {

1382 .
wb
 = wb,

1383 .
bio
 = bio

1385 
	`»ad_backšg_async_ÿÎback_Ú¡ack
(1, &
ùx
);

1387  
DM_MAPIO_SUBMITTED
;

1389 
	`bio_»m­
(
bio
, 
wb
->
backšg_dev
, 
	`bi_£ùÜ
(bio));

1390  
DM_MAPIO_REMAPPED
;

1394 
dœtšess
 = 
	`»ad_mb_dœtšess
(
wb
, 
»s
.
found_£g
,„es.
found_mb
);

1395 ià(
	`uÆik–y
(
»s
.
Ú_bufãr
)) {

1396 
”r
 = 
	`fl_·ylßd_by_backšg
(
wb
, 
bio
);

1397 ià(
”r
)

1398 
»ad_bufã»d_mb_ex™
;

1400 ià(
dœtšess
.
is_dœty
)

1401 
	`cİy_to_bio_·ylßd
(
bio
, 
	`»f_bufã»d_mb
(
wb
, 
»s
.
found_mb
), 
dœtšess
.
d©a_b™s
);

1403 
»ad_bufã»d_mb_ex™
:

1404 
	`dec_šæight_ios
(
wb
, 
»s
.
found_£g
);

1406 ià(
	`uÆik–y
(
”r
))

1407 
	`bio_io_”rÜ
(
bio
);

1409 
	`bio_io_sucûss_com·t
(
bio
);

1411  
DM_MAPIO_SUBMITTED
;

1418 
	`wa™_fÜ_æushšg
(
wb
, 
»s
.
found_£g
->
id
);

1420 ià(
	`uÆik–y
(
dœtšess
.
d©a_b™s
 != 255)) {

1421 
”r
 = 
	`fl_·ylßd_by_backšg
(
wb
, 
bio
);

1422 ià(
”r
)

1423 
»ad_mb_ex™
;

1425 ià(
dœtšess
.
is_dœty
) {

1426 *
buf
 = 
	`»ad_mb
(
wb
, 
»s
.
found_£g
,„es.
found_mb
, 
dœtšess
.
d©a_b™s
);

1427 ià(!
buf
) {

1428 
”r
 = -
EIO
;

1429 
»ad_mb_ex™
;

1431 
	`cİy_to_bio_·ylßd
(
bio
, 
buf
, 
dœtšess
.
d©a_b™s
);

1432 
	`mempoŞ_ä“
(
buf
, 
wb
->
buf_8_poŞ
);

1435 
»ad_mb_ex™
:

1436 
	`dec_šæight_ios
(
wb
, 
»s
.
found_£g
);

1438 ià(
	`uÆik–y
(
”r
))

1439 
	`bio_io_”rÜ
(
bio
);

1441 
	`bio_io_sucûss_com·t
(
bio
);

1443  
DM_MAPIO_SUBMITTED
;

1446 
pbd
 = 
	`³r_bio_d©a
(
wb
, 
bio
);

1447 
pbd
->
ty³
 = 
PBD_READ_SEG
;

1448 
pbd
->
£g
 = 
»s
.
found_£g
;

1450 
	`bio_»m­
(
bio
, 
wb
->
ÿche_dev
,

1451 
	`ÿlc_mb_¡¬t_£ùÜ
(
wb
, 
»s
.
found_£g
,„es.
found_mb
->
idx
) +

1452 
	`bio_ÿlc_off£t
(
bio
));

1454  
DM_MAPIO_REMAPPED
;

1455 
	}
}

1457 
	$´oûss_bio
(
wb_deviû
 *
wb
, 
bio
 *bio)

1459  
	`bio_is_wr™e
(
bio
è? 
	`´oûss_wr™e
(
wb
, bioè: 
	`´oûss_»ad
(wb, bio);

1460 
	}
}

1462 
	$´oûss_b¬r›r_bio
(
wb_deviû
 *
wb
, 
bio
 *bio)

1465 
	`ASSERT
(
	`bio_£ùÜs
(
bio
) == 0);

1466 
	`queue_b¬r›r_io
(
wb
, 
bio
);

1467  
DM_MAPIO_SUBMITTED
;

1468 
	}
}

1470 
	$wr™eboo¡_m­
(
dm_rg‘
 *
ti
, 
bio
 *bio)

1472 
wb_deviû
 *
wb
 = 
ti
->
´iv©e
;

1474 
³r_bio_d©a
 *
pbd
 = 
	`³r_bio_d©a
(
wb
, 
bio
);

1475 
pbd
->
ty³
 = 
PBD_NONE
;

1477 ià(
	`bio_is_b¬r›r
(
bio
))

1478  
	`´oûss_b¬r›r_bio
(
wb
, 
bio
);

1480  
	`´oûss_bio
(
wb
, 
bio
);

1481 
	}
}

1489 #ià
LINUX_VERSION_CODE
 >ğ
KERNEL_VERSION
(4,13,0)

1490 
	#DM_ENDIO_DONE_COMPAT
 
DM_ENDIO_DONE


	)

1491 
	$wr™eboo¡_’d_io
(
dm_rg‘
 *
ti
, 
bio
 *bio, 
blk_¡©us_t
 *
”rÜ
)

1493 
	#DM_ENDIO_DONE_COMPAT
 0

	)

1494 
	$wr™eboo¡_’d_io
(
dm_rg‘
 *
ti
, 
bio
 *bio, 
”rÜ
)

1497 
wb_deviû
 *
wb
 = 
ti
->
´iv©e
;

1498 
³r_bio_d©a
 *
pbd
 = 
	`³r_bio_d©a
(
wb
, 
bio
);

1500 
pbd
->
ty³
) {

1501 
PBD_NONE
:

1502 
PBD_WILL_CACHE
:

1503  
DM_ENDIO_DONE_COMPAT
;

1504 
PBD_READ_SEG
:

1505 
	`dec_šæight_ios
(
wb
, 
pbd
->
£g
);

1506  
DM_ENDIO_DONE_COMPAT
;

1508 
	`BUG
();

1510 
	}
}

1512 
	$cÚsume_es£ÁŸl_¬gv
(
wb_deviû
 *
wb
, 
dm_¬g_£t
 *
as
)

1514 
”r
 = 0;

1515 
dm_rg‘
 *
ti
 = 
wb
->ti;

1517 
”r
 = 
	`dm_g‘_deviû
(
ti
, 
	`dm_shiá_¬g
(
as
), 
	`dm_bË_g‘_mode
Ñi->
bË
),

1518 &
wb
->
backšg_dev
);

1519 ià(
”r
) {

1520 
	`DMERR
("Failedo get backing_dev");

1521  
”r
;

1524 
”r
 = 
	`dm_g‘_deviû
(
ti
, 
	`dm_shiá_¬g
(
as
), 
	`dm_bË_g‘_mode
Ñi->
bË
),

1525 &
wb
->
ÿche_dev
);

1526 ià(
”r
) {

1527 
	`DMERR
("Failedo get cache_dev");

1528 
bad_g‘_ÿche
;

1531  
”r
;

1533 
bad_g‘_ÿche
:

1534 
	`dm_put_deviû
(
ti
, 
wb
->
backšg_dev
);

1535  
”r
;

1536 
	}
}

1538 
	#cÚsume_kv
(
Çme
, 
Ä
, 
is_¡©ic
) { \

1539 ià(!
	`¡rÿ£cmp
(
key
, #name)) { \

1540 ià(!
¬gc
) \

1542 ià(
	`‹¡_b™
(
WB_CREATED
, &
wb
->
æags
è&& 
is_¡©ic
) { \

1543 
	`DMERR
("%s is‡ static option", #name); \

1546 
”r
 = 
	`dm_»ad_¬g
(
_¬gs
 + (
Ä
), 
as
, &
tmp
, &
ti
->
”rÜ
); \

1547 ià(
”r
) { \

1548 
	`DMERR
("%s", 
ti
->
”rÜ
); \

1551 
wb
->
Çme
 = 
tmp
; \

1552 } }

	)

1554 
	$do_cÚsume_İtiÚ®_¬gv
(
wb_deviû
 *
wb
, 
dm_¬g_£t
 *
as
, 
¬gc
)

1556 
”r
 = 0;

1557 
dm_rg‘
 *
ti
 = 
wb
->ti;

1559 
dm_¬g
 
_¬gs
[] = {

1571 
tmp
;

1573 
¬gc
) {

1574 cÚ¡ *
key
 = 
	`dm_shiá_¬g
(
as
);

1575 
¬gc
--;

1577 
”r
 = -
EINVAL
;

1579 
	`cÚsume_kv
(
wr™eback_th»shŞd
, 0, 
çl£
);

1580 
	`cÚsume_kv
(
Ä_max_b©ched_wr™eback
, 1, 
çl£
);

1581 
	`cÚsume_kv
(
upd©e_sb_»cÜd_š‹rv®
, 2, 
çl£
);

1582 
	`cÚsume_kv
(
sync_d©a_š‹rv®
, 3, 
çl£
);

1583 
	`cÚsume_kv
(
»ad_ÿche_th»shŞd
, 4, 
çl£
);

1584 
	`cÚsume_kv
(
wr™e_¬ound_mode
, 5, 
Œue
);

1585 
	`cÚsume_kv
(
Ä_»ad_ÿche_ûÎs
, 6, 
Œue
);

1586 
	`cÚsume_kv
(
ad­tive_wr™e_mode
, 7, 
çl£
);

1587 
	`cÚsume_kv
(
£qu’tŸl_th»shŞd
, 8, 
çl£
);

1589 ià(!
”r
) {

1590 
¬gc
--;

1592 
ti
->
”rÜ
 = "Invalid optional key";

1597  
”r
;

1598 
	}
}

1600 
	$cÚsume_İtiÚ®_¬gv
(
wb_deviû
 *
wb
, 
dm_¬g_£t
 *
as
)

1602 
”r
 = 0;

1603 
dm_rg‘
 *
ti
 = 
wb
->ti;

1605 
dm_¬g
 
_¬gs
[] = {

1609 
¬gc
 = 0;

1611 ià(
as
->
¬gc
) {

1612 
”r
 = 
	`dm_»ad_¬g_group
(
_¬gs
, 
as
, &
¬gc
, &
ti
->
”rÜ
);

1613 ià(
”r
) {

1614 
	`DMERR
("%s", 
ti
->
”rÜ
);

1615  
”r
;

1619  
	`do_cÚsume_İtiÚ®_¬gv
(
wb
, 
as
, 
¬gc
);

1620 
	}
}

1622 
DECLARE_DM_KCOPYD_THROTTLE_WITH_MODULE_PARM
(
wb_cİy_thrÙe
,

1625 
	$š™_cÜe_¡ruù
(
dm_rg‘
 *
ti
)

1627 
”r
 = 0;

1628 
wb_deviû
 *
wb
;

1630 
”r
 = 
	`dm_£t_rg‘_max_io_Ën
(
ti
, 1 << 3);

1631 ià(
”r
) {

1632 
	`DMERR
("Failedo set max_io_len");

1633  
”r
;

1636 
ti
->
num_æush_bios
 = 1;

1637 
ti
->
æush_suµÜ‹d
 = 
Œue
;

1647 
ti
->
num_disÿrd_bios
 = 0;

1648 
ti
->
disÿrds_suµÜ‹d
 = 
çl£
;

1650 
ti
->
PER_BIO_DATA_SIZE
 = (
³r_bio_d©a
);

1652 
wb
 = 
	`kz®loc
((*wb), 
GFP_KERNEL
);

1653 ià(!
wb
) {

1654 
	`DMERR
("Failedo‡llocate wb");

1655  -
ENOMEM
;

1657 
ti
->
´iv©e
 = 
wb
;

1658 
wb
->
ti
 =i;

1660 
wb
->
cİ›r
 = 
	`dm_kcİyd_ş›Á_ü—‹
(&
dm_kcİyd_thrÙe
);

1661 ià(
	`IS_ERR
(
wb
->
cİ›r
)) {

1662 
”r
 = 
	`PTR_ERR
(
wb
->
cİ›r
);

1663 
bad_kcİyd_ş›Á
;

1666 
wb
->
buf_8_ÿch•
 = 
	`kmem_ÿche_ü—‹
("dmwb_buf_8",

1667 1 << 12, 1 << 12, 
SLAB_RED_ZONE
, 
NULL
);

1668 ià(!
wb
->
buf_8_ÿch•
) {

1669 
”r
 = -
ENOMEM
;

1670 
bad_buf_8_ÿch•
;

1672 
wb
->
buf_8_poŞ
 = 
	`mempoŞ_ü—‹_¦ab_poŞ
(16, wb->
buf_8_ÿch•
);

1673 ià(!
wb
->
buf_8_poŞ
) {

1674 
”r
 = -
ENOMEM
;

1675 
bad_buf_8_poŞ
;

1678 
wb
->
io_wq
 = 
	`ü—‹_sšgËth»ad_wÜkqueue
("dmwb_io");

1679 ià(!
wb
->
io_wq
) {

1680 
	`DMERR
("Failedo‡llocate io_wq");

1681 
”r
 = -
ENOMEM
;

1682 
bad_io_wq
;

1685 
wb
->
io_ş›Á
 = 
	`dm_io_ş›Á_ü—‹
();

1686 ià(
	`IS_ERR
(
wb
->
io_ş›Á
)) {

1687 
	`DMERR
("Failedo‡llocate io_client");

1688 
”r
 = 
	`PTR_ERR
(
wb
->
io_ş›Á
);

1689 
bad_io_ş›Á
;

1692 
	`mu‹x_š™
(&
wb
->
io_lock
);

1693 
	`š™_wa™queue_h—d
(&
wb
->
šæight_ios_wq
);

1694 
	`¥š_lock_š™
(&
wb
->
mb_lock
);

1695 
	`©omic64_£t
(&
wb
->
Ä_dœty_ÿches
, 0);

1696 
	`ş—r_b™
(
WB_CREATED
, &
wb
->
æags
);

1698  
”r
;

1700 
bad_io_ş›Á
:

1701 
	`de¡roy_wÜkqueue
(
wb
->
io_wq
);

1702 
bad_io_wq
:

1703 
	`mempoŞ_de¡roy
(
wb
->
buf_8_poŞ
);

1704 
bad_buf_8_poŞ
:

1705 
	`kmem_ÿche_de¡roy
(
wb
->
buf_8_ÿch•
);

1706 
bad_buf_8_ÿch•
:

1707 
	`dm_kcİyd_ş›Á_de¡roy
(
wb
->
cİ›r
);

1708 
bad_kcİyd_ş›Á
:

1709 
	`kä“
(
wb
);

1710  
”r
;

1711 
	}
}

1713 
	$ä“_cÜe_¡ruù
(
wb_deviû
 *
wb
)

1715 
	`dm_io_ş›Á_de¡roy
(
wb
->
io_ş›Á
);

1716 
	`de¡roy_wÜkqueue
(
wb
->
io_wq
);

1717 
	`mempoŞ_de¡roy
(
wb
->
buf_8_poŞ
);

1718 
	`kmem_ÿche_de¡roy
(
wb
->
buf_8_ÿch•
);

1719 
	`dm_kcİyd_ş›Á_de¡roy
(
wb
->
cİ›r
);

1720 
	`kä“
(
wb
);

1721 
	}
}

1723 
	$cİy_ùr_¬gs
(
wb_deviû
 *
wb
, 
¬gc
, cÚ¡ **
¬gv
)

1725 
i
;

1726 cÚ¡ **
cİy
;

1728 
cİy
 = 
	`kÿÎoc
(
¬gc
, (*cİy), 
GFP_KERNEL
);

1729 ià(!
cİy
)

1730  -
ENOMEM
;

1731 
i
 = 0; i < 
¬gc
; i++) {

1732 
cİy
[
i
] = 
	`k¡rdup
(
¬gv
[i], 
GFP_KERNEL
);

1733 ià(!
cİy
[
i
]) {

1734 
i
--)

1735 
	`kä“
(
cİy
[
i
]);

1736 
	`kä“
(
cİy
);

1737  -
ENOMEM
;

1741 
wb
->
Ä_ùr_¬gs
 = 
¬gc
;

1742 
wb
->
ùr_¬gs
 = 
cİy
;

1745 
	}
}

1747 
	$ä“_ùr_¬gs
(
wb_deviû
 *
wb
)

1749 
i
;

1750 
i
 = 0; i < 
wb
->
Ä_ùr_¬gs
; i++)

1751 
	`kä“
(
wb
->
ùr_¬gs
[
i
]);

1752 
	`kä“
(
wb
->
ùr_¬gs
);

1753 
	}
}

1755 
	#§ve_¬g
(
Çme
è
wb
->Çme##
_§ved
 = wb->
	)
name

1756 
	#»¡Üe_¬g
(
Çme
èià(
wb
->Çme##
_§ved
è{ wb->Çmğwb->Çme##_§ved; }

	)

1767 
	$wr™eboo¡_ùr
(
dm_rg‘
 *
ti
, 
¬gc
, **
¬gv
)

1769 
”r
 = 0;

1770 
wb_deviû
 *
wb
;

1772 
dm_¬g_£t
 
as
;

1773 
as
.
¬gc
 =‡rgc;

1774 
as
.
¬gv
 =‡rgv;

1776 
”r
 = 
	`š™_cÜe_¡ruù
(
ti
);

1777 ià(
”r
) {

1778 
ti
->
”rÜ
 = "init_core_struct failed";

1779  
”r
;

1781 
wb
 = 
ti
->
´iv©e
;

1783 
”r
 = 
	`cİy_ùr_¬gs
(
wb
, 
¬gc
 - 2, (cÚ¡ **)
¬gv
 + 2);

1784 ià(
”r
) {

1785 
ti
->
”rÜ
 = "copy_ctr_args failed";

1786 
bad_ùr_¬gs
;

1789 
”r
 = 
	`cÚsume_es£ÁŸl_¬gv
(
wb
, &
as
);

1790 ià(
”r
) {

1791 
ti
->
”rÜ
 = "consume_essential_argv failed";

1792 
bad_es£ÁŸl_¬gv
;

1795 
”r
 = 
	`cÚsume_İtiÚ®_¬gv
(
wb
, &
as
);

1796 ià(
”r
) {

1797 
ti
->
”rÜ
 = "consume_optional_argv failed";

1798 
bad_İtiÚ®_¬gv
;

1801 
	`§ve_¬g
(
wr™eback_th»shŞd
);

1802 
	`§ve_¬g
(
Ä_max_b©ched_wr™eback
);

1803 
	`§ve_¬g
(
upd©e_sb_»cÜd_š‹rv®
);

1804 
	`§ve_¬g
(
sync_d©a_š‹rv®
);

1805 
	`§ve_¬g
(
»ad_ÿche_th»shŞd
);

1806 
	`§ve_¬g
(
Ä_»ad_ÿche_ûÎs
);

1807 
	`§ve_¬g
(
ad­tive_wr™e_mode
);

1808 
	`§ve_¬g
(
£qu’tŸl_th»shŞd
);

1810 
”r
 = 
	`»sume_ÿche
(
wb
);

1811 ià(
”r
) {

1812 
ti
->
”rÜ
 = "resume_cache failed";

1813 
bad_»sume_ÿche
;

1816 
wb
->
Ä_»ad_ÿche_ûÎs
 = 2048;

1817 
	`»¡Üe_¬g
(
Ä_»ad_ÿche_ûÎs
);

1818 
”r
 = 
	`š™_»ad_ÿche_ûÎs
(
wb
);

1819 ià(
”r
) {

1820 
ti
->
”rÜ
 = "init_read_cache_cells failed";

1821 
bad_»ad_ÿche_ûÎs
;

1824 
	`ş—r_¡©
(
wb
);

1826 
	`£t_b™
(
WB_CREATED
, &
wb
->
æags
);

1828 
	`»¡Üe_¬g
(
wr™eback_th»shŞd
);

1829 
	`»¡Üe_¬g
(
Ä_max_b©ched_wr™eback
);

1830 
	`»¡Üe_¬g
(
upd©e_sb_»cÜd_š‹rv®
);

1831 
	`»¡Üe_¬g
(
sync_d©a_š‹rv®
);

1832 
	`»¡Üe_¬g
(
»ad_ÿche_th»shŞd
);

1833 
	`»¡Üe_¬g
(
ad­tive_wr™e_mode
);

1834 
	`»¡Üe_¬g
(
£qu’tŸl_th»shŞd
);

1836  
”r
;

1838 
bad_»ad_ÿche_ûÎs
:

1839 
	`ä“_ÿche
(
wb
);

1840 
bad_»sume_ÿche
:

1841 
	`dm_put_deviû
(
ti
, 
wb
->
ÿche_dev
);

1842 
	`dm_put_deviû
(
ti
, 
wb
->
backšg_dev
);

1843 
bad_İtiÚ®_¬gv
:

1844 
bad_es£ÁŸl_¬gv
:

1845 
	`ä“_ùr_¬gs
(
wb
);

1846 
bad_ùr_¬gs
:

1847 
	`ä“_cÜe_¡ruù
(
wb
);

1848 
ti
->
´iv©e
 = 
NULL
;

1850  
”r
;

1851 
	}
}

1853 
	$wr™eboo¡_dŒ
(
dm_rg‘
 *
ti
)

1855 
wb_deviû
 *
wb
 = 
ti
->
´iv©e
;

1857 
	`ä“_»ad_ÿche_ûÎs
(
wb
);

1859 
	`ä“_ÿche
(
wb
);

1861 
	`dm_put_deviû
(
ti
, 
wb
->
ÿche_dev
);

1862 
	`dm_put_deviû
(
ti
, 
wb
->
backšg_dev
);

1864 
	`ä“_ùr_¬gs
(
wb
);

1866 
	`ä“_cÜe_¡ruù
(
wb
);

1867 
ti
->
´iv©e
 = 
NULL
;

1868 
	}
}

1876 
	$wr™eboo¡_po¡su¥’d
(
dm_rg‘
 *
ti
)

1878 
wb_deviû
 *
wb
 = 
ti
->
´iv©e
;

1879 
	`æush_cu¼’t_bufãr
(
wb
);

1880 
	`blkdev_issue_æush
(
wb
->
ÿche_dev
->
bdev
, 
GFP_NOIO
, 
NULL
);

1881 
	}
}

1883 
	$wr™eboo¡_mes§ge
(
dm_rg‘
 *
ti
, 
¬gc
, **
¬gv
)

1885 
wb_deviû
 *
wb
 = 
ti
->
´iv©e
;

1887 
dm_¬g_£t
 
as
;

1888 
as
.
¬gc
 =‡rgc;

1889 
as
.
¬gv
 =‡rgv;

1891 ià(!
	`¡rÿ£cmp
(
¬gv
[0], "clear_stat")) {

1892 
	`ş—r_¡©
(
wb
);

1896 ià(!
	`¡rÿ£cmp
(
¬gv
[0], "drop_caches")) {

1897 
”r
 = 0;

1898 
wb
->
fÜû_drİ
 = 
Œue
;

1899 
”r
 = 
	`wa™_ev’t_š‹¼u±ibË
(
wb
->
wa™_drİ_ÿches
,

1900 !
	`©omic64_»ad
(&
wb
->
Ä_dœty_ÿches
));

1901 
wb
->
fÜû_drİ
 = 
çl£
;

1902  
”r
;

1905 if(!
	`¡rÿ£cmp
(
¬gv
[0], "write_around_mode_true")) {

1906 
wb
->
wr™e_¬ound_mode
 = 
Œue
;

1910 if(!
	`¡rÿ£cmp
(
¬gv
[0], "write_around_mode_false")) {

1911 
wb
->
wr™e_¬ound_mode
 = 
çl£
;

1915 ià(!
	`¡rÿ£cmp
(
¬gv
[0], "adaptive_write_mode_true")) {

1916 
wb
->
ad­tive_wr™e_mode
 = 
Œue
;

1920 ià(!
	`¡rÿ£cmp
(
¬gv
[0], "adaptive_write_mode_false")) {

1921 
wb
->
ad­tive_wr™e_mode
 = 
çl£
;

1925  
	`do_cÚsume_İtiÚ®_¬gv
(
wb
, &
as
, 2);

1926 
	}
}

1928 
	$wr™eboo¡_™”©e_deviûs
(
dm_rg‘
 *
ti
,

1929 
™”©e_deviûs_ÿÎout_â
 
â
, *
d©a
)

1931 
r
 = 0;

1932 
wb_deviû
 *
wb
 = 
ti
->
´iv©e
;

1934 
r
 = 
	`â
(
ti
, 
wb
->
ÿche_dev
, 0, 
	`dm_devsize
(wb->ÿche_dev), 
d©a
);

1935 ià(!
r
)

1936 
r
 = 
	`â
(
ti
, 
wb
->
backšg_dev
, 0,i->
Ën
, 
d©a
);

1938  
r
;

1939 
	}
}

1941 
	$wr™eboo¡_io_hšts
(
dm_rg‘
 *
ti
, 
queue_lim™s
 *
lim™s
)

1943 
	`blk_lim™s_io_İt
(
lim™s
, 4096);

1944 
	}
}

1946 
	$wr™eboo¡_¡©us
(
dm_rg‘
 *
ti
, 
¡©us_ty³_t
 
ty³
,

1947 
æags
, *
»suÉ
, 
maxËn
)

1949 
ssize_t
 
sz
 = 0;

1950 
buf
[
BDEVNAME_SIZE
];

1951 
wb_deviû
 *
wb
 = 
ti
->
´iv©e
;

1952 
size_t
 
i
;

1954 
ty³
) {

1955 
STATUSTYPE_INFO
:

1956 
	`DMEMIT
("\ncursor: %u\nnr_caches: %u\nnr_segments: %llu\ncurrent_seg->id: %llu\nqueued_Sid: %llu\nflush_Sid: %llu\nwriteback_Sid: %llu\nnr_dirty_caches: %llu\n",

1958 
wb
->
cursÜ
,

1960 
wb
->
Ä_ÿches
,

1962 
wb
->
Ä_£gm’ts
,

1964 
wb
->
cu¼’t_£g
->
id
,

1966 
	`©omic64_»ad
(&
wb
->
Ï¡_queued_£gm’t_id
),

1968 
	`©omic64_»ad
(&
wb
->
Ï¡_æushed_£gm’t_id
),

1970 
	`©omic64_»ad
(&
wb
->
Ï¡_wr™eback_£gm’t_id
),

1972 
	`©omic64_»ad
(&
wb
->
Ä_dœty_ÿches
));

1974 
i
 = 0; i < 
STATLEN
; i++) {

1975 
©omic64_t
 *
v
 = &
wb
->
¡©
[
i
];

1976 
	`DMEMIT
(" %Îu ", (è
	`©omic64_»ad
(
v
));

1978 
	`DMEMIT
(" %Îu\n", (è
	`©omic64_»ad
(&
wb
->
couÁ_nÚ_fuÎ_æushed
));

1981 
	`DMEMIT
("‚r_max_batched_writeback: %d\n",

1982 
wb
->
Ä_max_b©ched_wr™eback
);

1983 
	`DMEMIT
(" writeback_threshold: %d\n",

1984 
wb
->
wr™eback_th»shŞd
);

1985 
	`DMEMIT
("‚r_cur_batched_writeback: %u\n",

1986 
wb
->
Ä_cur_b©ched_wr™eback
);

1987 
	`DMEMIT
(" sync_data_interval: %lu\n",

1988 
wb
->
sync_d©a_š‹rv®
);

1989 
	`DMEMIT
(" update_sb_record_interval: %lu\n",

1990 
wb
->
upd©e_sb_»cÜd_š‹rv®
);

1991 
	`DMEMIT
("„ead_cache_threshold: %u\n",

1992 
wb
->
»ad_ÿche_th»shŞd
);

1993 
	`DMEMIT
("‚r_empty_segs: %u\n",

1994 
wb
->
Ä_em±y_£gs
);

1995 
	`DMEMIT
("‚r_read_cache_cells: %u\n",

1996 
wb
->
Ä_»ad_ÿche_ûÎs
);

1997 
	`DMEMIT
(" write_around_mode: %u\n",

1998 
wb
->
wr™e_¬ound_mode
);

1999 
	`DMEMIT
("‡daptive_write_mode: %u\n",

2000 
wb
->
ad­tive_wr™e_mode
);

2001 
	`DMEMIT
(" sequential_threshold: %u\n",

2002 
wb
->
£qu’tŸl_th»shŞd
);

2005 
STATUSTYPE_TABLE
:

2006 
	`fÜm©_dev_t
(
buf
, 
wb
->
backšg_dev
->
bdev
->
bd_dev
);

2007 
	`DMEMIT
("%s", 
buf
);

2008 
	`fÜm©_dev_t
(
buf
, 
wb
->
ÿche_dev
->
bdev
->
bd_dev
);

2009 
	`DMEMIT
(" %s", 
buf
);

2011 
i
 = 0; i < 
wb
->
Ä_ùr_¬gs
; i++)

2012 
	`DMEMIT
(" %s", 
wb
->
ùr_¬gs
[
i
]);

2015 
	}
}

2017 
rg‘_ty³
 
	gwr™eboo¡_rg‘
 = {

2018 .
Çme
 = "writeboost",

2019 .
	gv”siÚ
 = {2, 2, 8},

2020 .
	gmoduË
 = 
THIS_MODULE
,

2021 .
	gm­
 = 
wr™eboo¡_m­
,

2022 .
	g’d_io
 = 
wr™eboo¡_’d_io
,

2023 .
	gùr
 = 
wr™eboo¡_ùr
,

2024 .
	gdŒ
 = 
wr™eboo¡_dŒ
,

2025 .
	gpo¡su¥’d
 = 
wr™eboo¡_po¡su¥’d
,

2026 .
	gmes§ge
 = 
wr™eboo¡_mes§ge
,

2027 .
	g¡©us
 = 
wr™eboo¡_¡©us
,

2028 .
	gio_hšts
 = 
wr™eboo¡_io_hšts
,

2029 .
	g™”©e_deviûs
 = 
wr™eboo¡_™”©e_deviûs
,

2032 
__š™
 
	$wr™eboo¡_moduË_š™
()

2034 
”r
 = 0;

2036 
”r
 = 
	`dm_»gi¡”_rg‘
(&
wr™eboo¡_rg‘
);

2037 ià(
”r
 < 0) {

2038 
	`DMERR
("Failedo„egisterarget");

2039  
”r
;

2042  
”r
;

2043 
	}
}

2045 
__ex™
 
	$wr™eboo¡_moduË_ex™
()

2047 
	`dm_uÄegi¡”_rg‘
(&
wr™eboo¡_rg‘
);

2048 
	}
}

2050 
moduË_š™
(
wr™eboo¡_moduË_š™
);

2051 
moduË_ex™
(
wr™eboo¡_moduË_ex™
);

2053 
MODULE_AUTHOR
("Akira Hayakawa <ruby.wktk@gmail.com>");

2054 
MODULE_DESCRIPTION
(
DM_NAME
 " writeboostarget");

2055 
MODULE_LICENSE
("GPL");

	@dm-writeboost.h

20 #iâdeà
DM_WRITEBOOST_H


21 
	#DM_WRITEBOOST_H


	)

23 
	#DM_MSG_PREFIX
 "wr™eboo¡"

	)

25 
	~<lšux/moduË.h
>

26 
	~<lšux/v”siÚ.h
>

27 
	~<lšux/li¡.h
>

28 
	~<lšux/¦ab.h
>

29 
	~<lšux/vm®loc.h
>

30 
	~<lšux/mu‹x.h
>

31 
	~<lšux/kth»ad.h
>

32 
	~<lšux/sched.h
>

33 
	~<lšux/tim”.h
>

34 
	~<lšux/wÜkqueue.h
>

35 
	~<lšux/üc32c.h
>

36 
	~<lšux/deviû-m­³r.h
>

37 
	~<lšux/dm-io.h
>

38 
	~<lšux/dm-kcİyd.h
>

41 #iâdeà
RHEL_RELEASE_CODE


42 
	#RHEL_RELEASE_CODE
 0

	)

43 
	#RHEL_RELEASE_VERSION
(
a
,
b
è((×è<< 8è+ (b))

	)

48 
	#SUB_ID
(
x
, 
y
è((xè> (yè? (xè- (yè: 0)

	)

77 
	#WB_MAGIC
 0x57427374

	)

78 
	ssu³rblock_h—d”_deviû
 {

79 
__Ë32
 
	mmagic
;

80 } 
	g__·cked
;

88 
	ssu³rblock_»cÜd_deviû
 {

89 
__Ë64
 
	mÏ¡_wr™eback_£gm’t_id
;

90 } 
	g__·cked
;

98 
	sm‘ablock_deviû
 {

99 
__Ë64
 
	m£ùÜ
;

100 
__u8
 
	mdœty_b™s
;

101 
__u8
 
	m·ddšg
[16 - (8 + 1)];

102 } 
	g__·cked
;

104 
	s£gm’t_h—d”_deviû
 {

112 
__Ë64
 
	mid
;

113 
__Ë32
 
	mchecksum
;

118 
__u8
 
	mËngth
;

119 
__u8
 
	m·ddšg
[512 - (8 + 4 + 1)];

121 
m‘ablock_deviû
 
	mmb¬r
[0];

122 } 
	g__·cked
;

126 
	sdœtšess
 {

127 
boŞ
 
	mis_dœty
;

128 
u8
 
	md©a_b™s
;

131 
	sm‘ablock
 {

133 
£ùÜ_t
 
	m£ùÜ
;

135 
u32
 
	midx
;

137 
hli¡_node
 
	mht_li¡
;

139 
dœtšess
 
	mdœtšess
;

142 
	#SZ_MAX
 (~(
size_t
)0)

	)

143 
	s£gm’t_h—d”
 {

144 
u64
 
	mid
;

146 
u8
 
	mËngth
;

148 
u32
 
	m¡¬t_idx
;

149 
£ùÜ_t
 
	m¡¬t_£ùÜ
;

151 
©omic_t
 
	mÄ_šæight_ios
;

153 
m‘ablock
 
	mmb_¬¿y
[0];

161 
	s¿mbufãr
 {

162 
£gm’t_h—d”
 *
	m£g
;

163 *
	md©a
;

164 
bio_li¡
 
	mb¬r›r_ios
;

185 
	swr™eback_io
 {

186 
rb_node
 
	mrb_node
;

188 
£ùÜ_t
 
	m£ùÜ
;

189 
u64
 
	mid
;

191 *
	md©a
;

192 
u8
 
	md©a_b™s
;

194 
	#wr™eback_io_äom_node
(
node
) \

195 
	`rb_’Œy
((
node
), 
wr™eback_io
, 
rb_node
)

	)

200 
	swr™eback_£gm’t
 {

201 
£gm’t_h—d”
 *
	m£g
;

202 
wr™eback_io
 *
	mios
;

203 *
	mbuf
;

208 
	s»ad_ÿche_ûÎ
 {

209 
£ùÜ_t
 
	m£ùÜ
;

210 *
	md©a
;

211 
boŞ
 
	mÿnûÎed
;

212 
rb_node
 
	mrb_node
;

215 
	s»ad_ÿche_ûÎs
 {

216 
u32
 
	msize
;

217 
»ad_ÿche_ûÎ
 *
	m¬¿y
;

218 
u32
 
	mcursÜ
;

219 
©omic_t
 
	mack_couÁ
;

220 
£ùÜ_t
 
	mÏ¡_£ùÜ
;

221 
u32
 
	m£qcouÁ
;

222 
u32
 
	mth»shŞd
;

223 
boŞ
 
	mov”_th»shŞd
;

229 
rb_roÙ
 
	mrb_roÙ
;

230 
wÜkqueue_¡ruù
 *
	mwq
;

235 
	eSTATFLAG
 {

236 
	mSTAT_WRITE
 = 3,

237 
	mSTAT_HIT
 = 2,

238 
	mSTAT_ON_BUFFER
 = 1,

239 
	mSTAT_FULLSIZE
 = 0,

241 
	#STATLEN
 (1 << 4)

	)

243 
	eWB_FLAG
 {

244 
	mWB_CREATED
 = 0,

247 
	#SEGMENT_SIZE_ORDER
 10

	)

248 
	#NR_RAMBUF_POOL
 8

	)

253 
	swb_deviû
 {

254 
dm_rg‘
 *
	mti
;

256 
dm_dev
 *
	mbackšg_dev
;

257 
dm_dev
 *
	mÿche_dev
;

259 
boŞ
 
	mwr™e_¬ound_mode
;

261 
	mÄ_ùr_¬gs
;

262 cÚ¡ **
	mùr_¬gs
;

264 
boŞ
 
	mdo_fÜm©
;

265 
mu‹x
 
	mio_lock
;

273 
wa™_queue_h—d_t
 
	mšæight_ios_wq
;

275 
¥šlock_t
 
	mmb_lock
;

277 
u8
 
	mÄ_ÿches_š£g
;

279 
kmem_ÿche
 *
	mbuf_8_ÿch•
;

280 
mempoŞ_t
 *
	mbuf_8_poŞ
;

281 
wÜkqueue_¡ruù
 *
	mio_wq
;

282 
dm_io_ş›Á
 *
	mio_ş›Á
;

290 
u32
 
	mcursÜ
;

291 
£gm’t_h—d”
 *
	mcu¼’t_£g
;

292 
¿mbufãr
 *
	mcu¼’t_¿mbuf
;

300 
u32
 
	mÄ_£gm’ts
;

301 
Ïrge_¬¿y
 *
	m£gm’t_h—d”_¬¿y
;

309 
u32
 
	mÄ_ÿches
;

310 
Ïrge_¬¿y
 *
	mhbË
;

311 
size_t
 
	mhtsize
;

318 
ht_h—d
 *
	mnuÎ_h—d
;

326 
¿mbufãr
 *
	m¿mbuf_poŞ
;

328 
©omic64_t
 
	mÏ¡_queued_£gm’t_id
;

336 
dm_kcİyd_ş›Á
 *
	mcİ›r
;

344 
sk_¡ruù
 *
	mæush_d«mÚ
;

350 
wa™_queue_h—d_t
 
	mæush_wa™_queue
;

352 
©omic64_t
 
	mÏ¡_æushed_£gm’t_id
;

364 
wÜkqueue_¡ruù
 *
	mb¬r›r_wq
;

365 
wÜk_¡ruù
 
	mæush_b¬r›r_wÜk
;

366 
bio_li¡
 
	mb¬r›r_ios
;

374 
sk_¡ruù
 *
	mwr™eback_d«mÚ
;

375 
	m®low_wr™eback
;

376 
	murge_wr™eback
;

377 
	mfÜû_drİ
;

378 
©omic64_t
 
	mÏ¡_wr™eback_£gm’t_id
;

384 
wa™_queue_h—d_t
 
	mwr™eback_wa™_queue
;

389 
wa™_queue_h—d_t
 
	mwa™_drİ_ÿches
;

390 
©omic64_t
 
	mÄ_dœty_ÿches
;

395 
wa™_queue_h—d_t
 
	mwr™eback_io_wa™_queue
;

396 
©omic_t
 
	mwr™eback_io_couÁ
;

397 
©omic_t
 
	mwr™eback_ç_couÁ
;

399 
u32
 
	mÄ_max_b©ched_wr™eback
;

400 
u32
 
	mÄ_max_b©ched_wr™eback_§ved
;

402 
rb_roÙ
 
	mwr™eback_Œ“
;

404 
u32
 
	mÄ_wr™eback_£gs
;

405 
wr™eback_£gm’t
 **
	mwr™eback_£gs
;

406 
u32
 
	mÄ_cur_b©ched_wr™eback
;

407 
u32
 
	mÄ_em±y_£gs
;

415 
sk_¡ruù
 *
	mwr™eback_moduÏtÜ
;

416 
u8
 
	mwr™eback_th»shŞd
;

417 
u8
 
	mwr™eback_th»shŞd_§ved
;

425 
sk_¡ruù
 *
	msb_»cÜd_upd©”
;

426 
	mupd©e_sb_»cÜd_š‹rv®
;

427 
	mupd©e_sb_»cÜd_š‹rv®_§ved
;

435 
sk_¡ruù
 *
	md©a_synchrÚiz”
;

436 
	msync_d©a_š‹rv®
;

437 
	msync_d©a_š‹rv®_§ved
;

445 
u32
 
	mÄ_»ad_ÿche_ûÎs
;

446 
u32
 
	mÄ_»ad_ÿche_ûÎs_§ved
;

447 
wÜk_¡ruù
 
	m»ad_ÿche_wÜk
;

448 
»ad_ÿche_ûÎs
 *
	m»ad_ÿche_ûÎs
;

449 
u32
 
	m»ad_ÿche_th»shŞd
;

450 
u32
 
	m»ad_ÿche_th»shŞd_§ved
;

458 
©omic64_t
 
	m¡©
[
STATLEN
];

459 
©omic64_t
 
	mcouÁ_nÚ_fuÎ_æushed
;

463 
	mæags
;

468 
boŞ
 
	mad­tive_wr™e_mode
;

469 
boŞ
 
	mad­tive_wr™e_mode_§ved
;

471 
u8
 
	m£qu’tŸl_th»shŞd
;

472 
u8
 
	m£qu’tŸl_th»shŞd_§ved
;

477 
	swr™e_io
 {

478 *
	md©a
;

479 
u8
 
	md©a_b™s
;

482 
acquœe_Ãw_£g
(
wb_deviû
 *, 
u64
 
id
);

483 
cursÜ_š™
(
wb_deviû
 *);

484 
æush_cu¼’t_bufãr
(
wb_deviû
 *);

485 
šc_Ä_dœty_ÿches
(
wb_deviû
 *);

486 
dec_Ä_dœty_ÿches
(
wb_deviû
 *);

487 
boŞ
 
m¬k_ş—n_mb
(
wb_deviû
 *, 
m‘ablock
 *);

488 
dœtšess
 
»ad_mb_dœtšess
(
wb_deviû
 *, 
£gm’t_h—d”
 *, 
m‘ablock
 *);

489 
´•¬e_ov”wr™e
(
wb_deviû
 *, 
£gm’t_h—d”
 *, 
m‘ablock
 *
Şd_mb
, 
wr™e_io
 *, 
u8
 
ov”wr™e_b™s
);

493 
	#ASSERT
(
cÚd
è
	`BUG_ON
(!(cÚd))

	)

495 
	#check_bufãr_®ignm’t
(
buf
) \

496 
	`do_check_bufãr_®ignm’t
(
buf
, #buf, 
__func__
)

	)

497 
do_check_bufãr_®ignm’t
(*, const *, const *);

499 
bio_io_sucûss_com·t
(
bio
 *bio);

505 
	#wb_io
(
io_»q
, 
num_»giÚs
, 
»giÚs
, 
”r_b™s
, 
th»ad
) \

506 
	`wb_io_š‹º®
(
wb
, (
io_»q
), (
num_»giÚs
), (
»giÚs
), \

507 (
”r_b™s
), (
th»ad
), 
__func__
)

	)

508 
wb_io_š‹º®
(
wb_deviû
 *, 
dm_io_»que¡
 *,

509 
num_»giÚs
, 
dm_io_»giÚ
 *,

510 *
”r_b™s
, 
boŞ
 
th»ad
, cÚ¡ *
ÿÎ”
);

512 
£ùÜ_t
 
dm_devsize
(
dm_dev
 *);

516 #ià
LINUX_VERSION_CODE
 >ğ
KERNEL_VERSION
(4,8,0)

517 
	#»q_is_wr™e
(
»q
è
	`İ_is_wr™e
(Ôeq)->
bi_İ
)

	)

518 
	#bio_is_b¬r›r
(
bio
è((bio)->
bi_İf
 & 
REQ_PREFLUSH
)

	)

519 
	#bio_is_fua
(
bio
è((bio)->
bi_İf
 & 
REQ_FUA
)

	)

520 
	#WB_IO_WRITE
 .
bi_İ
 = 
REQ_OP_WRITE
, .
bi_İ_æags
 = 0

	)

521 
	#WB_IO_READ
 .
bi_İ
 = 
REQ_OP_READ
, .
bi_İ_æags
 = 0

	)

522 
	#WB_IO_WRITE_FUA
 .
bi_İ
 = 
REQ_OP_WRITE
, .
bi_İ_æags
 = 
REQ_FUA


	)

524 
	#»q_is_wr™e
(
»q
è(Ôeq)->
bi_rw
 =ğ
WRITE
)

	)

525 
	#bio_is_b¬r›r
(
bio
è((bio)->
bi_rw
 & 
REQ_FLUSH
)

	)

526 
	#bio_is_fua
(
bio
è((bio)->
bi_rw
 & 
REQ_FUA
)

	)

527 
	#WB_IO_WRITE
 .
bi_rw
 = 
WRITE


	)

528 
	#WB_IO_READ
 .
bi_rw
 = 
READ


	)

529 
	#WB_IO_WRITE_FUA
 .
bi_rw
 = 
WRITE_FUA


	)

	@/usr/include/linux/sched.h

1 #iâdeà
_LINUX_SCHED_H


2 
	#_LINUX_SCHED_H


	)

7 
	#CSIGNAL
 0x000000fà

	)

8 
	#CLONE_VM
 0x00000100

	)

9 
	#CLONE_FS
 0x00000200

	)

10 
	#CLONE_FILES
 0x00000400

	)

11 
	#CLONE_SIGHAND
 0x00000800

	)

12 
	#CLONE_PTRACE
 0x00002000

	)

13 
	#CLONE_VFORK
 0x00004000

	)

14 
	#CLONE_PARENT
 0x00008000

	)

15 
	#CLONE_THREAD
 0x00010000

	)

16 
	#CLONE_NEWNS
 0x00020000

	)

17 
	#CLONE_SYSVSEM
 0x00040000

	)

18 
	#CLONE_SETTLS
 0x00080000

	)

19 
	#CLONE_PARENT_SETTID
 0x00100000

	)

20 
	#CLONE_CHILD_CLEARTID
 0x00200000

	)

21 
	#CLONE_DETACHED
 0x00400000

	)

22 
	#CLONE_UNTRACED
 0x00800000

	)

23 
	#CLONE_CHILD_SETTID
 0x01000000

	)

26 
	#CLONE_NEWUTS
 0x04000000

	)

27 
	#CLONE_NEWIPC
 0x08000000

	)

28 
	#CLONE_NEWUSER
 0x10000000

	)

29 
	#CLONE_NEWPID
 0x20000000

	)

30 
	#CLONE_NEWNET
 0x40000000

	)

31 
	#CLONE_IO
 0x80000000

	)

36 
	#SCHED_NORMAL
 0

	)

37 
	#SCHED_FIFO
 1

	)

38 
	#SCHED_RR
 2

	)

39 
	#SCHED_BATCH
 3

	)

41 
	#SCHED_IDLE
 5

	)

43 
	#SCHED_RESET_ON_FORK
 0x40000000

	)

	@/usr/include/linux/version.h

1 
	#LINUX_VERSION_CODE
 199947

	)

2 
	#KERNEL_VERSION
(
a
,
b
,
c
è((×è<< 16è+ ((bè<< 8è+ (c))

	)

	@
1
.
1
/usr/include
8
191
dm-writeboost-daemon.c
dm-writeboost-daemon.h
dm-writeboost-metadata.c
dm-writeboost-metadata.h
dm-writeboost-target.c
dm-writeboost.h
/usr/include/linux/sched.h
/usr/include/linux/version.h
